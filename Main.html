<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LiveKitaab ‚Äî Book Library</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Lora:ital,wght@0,400;0,500;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  :root {
    --brown:       #a46636;
    --brown-deep:  #7a4a22;
    --brown-dark:  #3b2010;
    --green:       #6bbf8e;
    --green-light: #a2d5a1;
    --green-dark:  #3d7a56;
    --cream:       #f6e9d7;
    --cream-dark:  #ecdcc4;
    --cream-deeper:#e0cdb0;
    --gold:        #f7e7b5;
    --gold-deep:   #d4a853;
    --text-dark:   #2a1a0e;
    --text-mid:    #5c3d1e;
    --text-light:  #8c6a45;
    --shadow-md:   0 4px 20px rgba(58,28,8,.14);
    --shadow-lg:   0 8px 40px rgba(58,28,8,.22);
    --radius:      12px;
    --radius-sm:   8px;
  }
  *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
  html, body { height:100%; }
  body { font-family:'DM Sans',sans-serif; background:var(--cream); color:var(--text-dark); min-height:100vh; overflow-x:hidden; }
  body::before { content:''; position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.035;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E"); }
  #app { position:relative; z-index:1; display:flex; flex-direction:column; min-height:100vh; }

  /* Nav */
  .topnav { background:var(--brown-dark); padding:0 24px; height:52px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 10px rgba(0,0,0,.35); position:sticky; top:0; z-index:100; }
  .topnav-brand { font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:700; color:var(--gold); letter-spacing:.02em; text-decoration:none; }
  .topnav-links { display:flex; gap:6px; align-items:center; }
  .topnav-links a { color:var(--cream); font-size:.82rem; text-decoration:none; padding:5px 12px; border-radius:20px; transition:background .2s,color .2s; }
  .topnav-links a:hover { background:rgba(246,233,215,.12); color:var(--gold); }
  .topnav-links .btn-account { background:var(--green); color:var(--brown-dark); font-weight:500; padding:5px 16px; }
  .topnav-links .btn-account:hover { background:var(--green-light); }

  /* Banner */
  .banner { background:linear-gradient(120deg,var(--green) 0%,var(--green-light) 55%,var(--gold-deep) 100%); padding:36px 32px 32px; display:flex; align-items:center; gap:20px; position:relative; overflow:hidden; }
  .banner::after { content:'üìö'; position:absolute; right:-10px; bottom:-18px; font-size:110px; opacity:.10; pointer-events:none; transform:rotate(-8deg); }
  .banner-icon { font-size:2.6rem; flex-shrink:0; filter:drop-shadow(0 2px 6px rgba(0,0,0,.15)); }
  .banner-text h1 { font-family:'Playfair Display',serif; font-size:clamp(1.5rem,4vw,2rem); font-weight:900; color:var(--brown-dark); line-height:1.15; }
  .banner-text p { font-family:'Lora',serif; font-style:italic; color:var(--brown-deep); font-size:.9rem; margin-top:5px; }

  /* Filter */
  .filter-bar { background:var(--cream-dark); border-bottom:1.5px solid var(--cream-deeper); padding:10px 20px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .filter-label { font-size:.78rem; font-weight:500; color:var(--text-light); text-transform:uppercase; letter-spacing:.08em; margin-right:4px; }
  .chip { display:inline-flex; align-items:center; gap:5px; padding:4px 14px; border-radius:20px; font-size:.8rem; cursor:pointer; transition:all .2s; border:1.5px solid var(--brown); color:var(--brown); background:transparent; font-family:'DM Sans',sans-serif; white-space:nowrap; }
  .chip.active { background:var(--green); border-color:var(--green); color:var(--brown-dark); font-weight:500; }
  .chip:hover:not(.active) { background:rgba(164,102,54,.07); }
  .filter-spacer { flex:1; }
  #statusText { font-size:.78rem; color:var(--text-light); font-style:italic; }

  /* Tabs */
  .tab-strip { display:flex; background:var(--brown-dark); border-bottom:2px solid rgba(164,102,54,.35); position:sticky; top:52px; z-index:90; }
  .tab-btn { flex:1; padding:13px 8px; text-align:center; font-family:'DM Sans',sans-serif; font-size:.84rem; font-weight:500; color:rgba(246,233,215,.55); cursor:pointer; border:none; background:transparent; transition:all .2s; border-bottom:3px solid transparent; margin-bottom:-2px; white-space:nowrap; }
  .tab-btn.active { color:var(--gold); border-bottom-color:var(--gold-deep); }
  .tab-btn:hover:not(.active) { color:var(--cream); background:rgba(246,233,215,.06); }

  /* Shelf */
  .tab-panel { display:none; padding:28px 16px 80px; animation:fadeIn .2s ease;
    background: repeating-linear-gradient(180deg,rgba(0,0,0,0) 0px,rgba(0,0,0,0) 17px,rgba(0,0,0,.05) 17px,rgba(0,0,0,.05) 18px,rgba(255,255,255,.03) 18px,rgba(255,255,255,.03) 19px,rgba(0,0,0,0) 19px,rgba(0,0,0,0) 36px),
    linear-gradient(172deg,#5c2e10 0%,#7a4422 20%,#a46636 40%,#8b5530 58%,#7a4422 75%,#5c2e10 100%);
    box-shadow:inset 0 8px 20px rgba(0,0,0,.30),inset 0 -4px 10px rgba(0,0,0,.20); min-height:280px; }
  .tab-panel.active { display:block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  /* Grid */
  .book-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(155px,1fr)); gap:18px; }
  .empty-state { text-align:center; padding:60px 20px; color:var(--gold); font-family:'Lora',serif; font-style:italic; font-size:1rem; text-shadow:0 1px 3px rgba(0,0,0,.4); }
  .empty-state span { display:block; font-size:2.5rem; margin-bottom:12px; }

  /* Card */
  .book-card { background:var(--cream); border-radius:var(--radius); box-shadow:0 6px 18px rgba(0,0,0,.40),0 2px 4px rgba(0,0,0,.22); overflow:hidden; cursor:pointer; transition:transform .22s ease,box-shadow .22s ease; display:flex; flex-direction:column; }
  .book-card:hover { transform:translateY(-8px) scale(1.02); box-shadow:0 18px 36px rgba(0,0,0,.50),0 4px 8px rgba(0,0,0,.28); }
  .cover-wrap { position:relative; }
  .book-cover { width:100%; aspect-ratio:2/3; object-fit:cover; display:block; }
  .book-cover-placeholder { width:100%; aspect-ratio:2/3; background:linear-gradient(135deg,var(--brown) 0%,var(--brown-deep) 100%); display:flex; align-items:center; justify-content:center; font-size:2.4rem; color:var(--gold); opacity:.7; }
  .book-badge { position:absolute; top:8px; right:8px; padding:2px 8px; border-radius:10px; font-size:.65rem; font-weight:600; letter-spacing:.04em; text-transform:uppercase; }
  .badge-free { background:var(--green); color:var(--brown-dark); }
  .badge-paid { background:var(--gold-deep); color:var(--brown-dark); }
  .book-info { padding:10px 10px 0; flex:1; }
  .book-title { font-family:'Playfair Display',serif; font-size:.88rem; font-weight:600; color:var(--text-dark); line-height:1.35; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .book-author { font-family:'Lora',serif; font-style:italic; font-size:.72rem; color:var(--text-light); margin-top:3px; }
  .book-action { padding:8px 10px 10px; }
  .btn { width:100%; padding:7px; border:none; border-radius:var(--radius-sm); font-family:'DM Sans',sans-serif; font-size:.78rem; font-weight:500; cursor:pointer; transition:all .18s; display:flex; align-items:center; justify-content:center; gap:5px; }
  .btn-read { background:var(--green); color:var(--brown-dark); }
  .btn-read:hover { background:var(--green-dark); color:white; }
  .btn-buy { background:var(--brown); color:var(--cream); }
  .btn-buy:hover { background:var(--brown-deep); }
  .btn-muted { background:var(--cream-dark); color:var(--text-mid); border:1.5px solid var(--cream-deeper); }

  /* Modal */
  .modal-overlay { position:fixed; inset:0; z-index:200; background:rgba(42,26,14,.62); backdrop-filter:blur(5px); display:flex; align-items:center; justify-content:center; padding:16px; opacity:0; pointer-events:none; transition:opacity .22s; }
  .modal-overlay.open { opacity:1; pointer-events:all; }
  .modal { background:var(--cream); border-radius:var(--radius); box-shadow:var(--shadow-lg); padding:24px 22px; width:100%; max-width:420px; transform:translateY(16px) scale(.98); transition:transform .22s ease; max-height:94vh; overflow-y:auto; }
  .modal-overlay.open .modal { transform:translateY(0) scale(1); }
  .modal-title { font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--text-dark); margin-bottom:2px; }
  .modal-sub { font-size:.78rem; color:var(--text-light); }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-top:14px; }
  .modal-actions .btn { width:auto; padding:8px 18px; font-size:.8rem; }
  .btn-ghost { background:transparent; color:var(--text-light); border:1.5px solid var(--cream-deeper); }
  .btn-ghost:hover { background:var(--cream-dark); }
  .btn-green { background:var(--green); color:var(--brown-dark); font-weight:600; }
  .btn-green:hover { background:var(--green-dark); color:white; }
  .btn-gold { background:var(--gold-deep); color:var(--brown-dark); font-weight:600; }
  .btn-gold:hover { filter:brightness(1.08); }
  .field { width:100%; padding:9px 12px; border-radius:var(--radius-sm); border:1.5px solid var(--cream-deeper); background:white; font-family:'DM Sans',sans-serif; font-size:.85rem; color:var(--text-dark); outline:none; transition:border-color .18s; margin-bottom:8px; }
  .field:focus { border-color:var(--green); }
  .field::placeholder { color:var(--text-light); }
  .divider { height:1px; background:var(--cream-deeper); margin:14px 0; }

  /* Step bar */
  .steps { display:flex; align-items:center; margin:14px 0 16px; }
  .sdot { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.7rem; font-weight:700; flex-shrink:0; transition:all .25s; background:var(--cream-deeper); color:var(--text-light); }
  .sdot.on  { background:var(--brown); color:white; box-shadow:0 0 0 3px rgba(164,102,54,.2); }
  .sdot.ok  { background:var(--green); color:var(--brown-dark); }
  .sline { flex:1; height:2px; background:var(--cream-deeper); transition:background .25s; }
  .sline.ok { background:var(--green); }
  .scol { display:flex; flex-direction:column; align-items:center; }
  .slabel { font-size:.62rem; color:var(--text-light); margin-top:3px; white-space:nowrap; }

  /* QR box */
  .qr-box { background:white; border-radius:var(--radius); border:2px solid var(--cream-deeper); padding:16px; text-align:center; margin-bottom:10px; }
  .qr-eyebrow { font-size:.67rem; text-transform:uppercase; letter-spacing:.08em; color:var(--text-light); font-weight:600; margin-bottom:10px; }
  #qrcode { display:inline-block; line-height:0; border-radius:6px; overflow:hidden; }
  #qrcode canvas, #qrcode img { display:block; }
  .amount-pill { display:inline-block; margin-top:10px; background:var(--gold); color:var(--brown-dark); font-family:'Playfair Display',serif; font-size:1.15rem; font-weight:700; padding:4px 20px; border-radius:20px; border:1.5px solid var(--gold-deep); }
  .upi-row { margin-top:7px; display:flex; align-items:center; justify-content:center; gap:6px; flex-wrap:wrap; }
  .upi-chip { font-size:.7rem; font-family:monospace; background:var(--cream-dark); color:var(--text-mid); padding:3px 10px; border-radius:6px; }
  .copy-btn { font-size:.67rem; padding:3px 9px; border-radius:6px; border:1px solid var(--cream-deeper); background:white; color:var(--text-mid); cursor:pointer; font-family:'DM Sans',sans-serif; transition:all .15s; }
  .copy-btn:hover { background:var(--cream-dark); }
  .app-chips { display:flex; gap:5px; justify-content:center; flex-wrap:wrap; margin-top:8px; }
  .app-chip { font-size:.63rem; padding:2px 8px; border-radius:8px; background:var(--cream-dark); color:var(--text-mid); border:1px solid var(--cream-deeper); }

  /* Info box styles */
  .info-box { border-radius:var(--radius-sm); padding:13px; margin-bottom:10px; }
  .info-box.green { background:rgba(107,191,142,.10); border:1.5px solid rgba(107,191,142,.35); }
  .info-box.gold  { background:rgba(212,168,83,.10);  border:1.5px solid rgba(212,168,83,.38); }
  .ibox-title { font-size:.68rem; font-weight:700; text-transform:uppercase; letter-spacing:.07em; margin-bottom:7px; }
  .ibox-title.green { color:var(--green-dark); }
  .ibox-title.gold  { color:#a07820; }
  .ibox-body  { font-size:.75rem; color:var(--text-mid); line-height:1.6; }
  .ibox-body strong { color:var(--text-dark); }
  .ibox-where { font-size:.69rem; color:var(--text-light); background:var(--cream-dark); border-radius:6px; padding:7px 10px; line-height:1.7; margin-top:8px; }

  /* Author link */
  .author-toggle { font-size:.7rem; color:var(--text-light); text-align:center; margin-top:10px; cursor:pointer; text-decoration:underline dotted var(--cream-deeper); transition:color .15s; user-select:none; }
  .author-toggle:hover { color:var(--brown); }

  /* Spinner */
  .spinner-wrap { text-align:center; padding:28px 0; }
  .spinner { width:34px; height:34px; border:3px solid var(--cream-deeper); border-top-color:var(--green); border-radius:50%; animation:spin .75s linear infinite; margin:0 auto 12px; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .spinner-label { font-size:.82rem; color:var(--text-mid); }

  /* Success */
  .success-wrap { text-align:center; padding:18px 0 8px; }
  .success-emoji { font-size:3rem; animation:pop .35s ease; margin-bottom:8px; }
  @keyframes pop { 0%{transform:scale(0)} 80%{transform:scale(1.15)} 100%{transform:scale(1)} }
  .success-title { font-family:'Playfair Display',serif; font-size:1.05rem; color:var(--text-dark); }
  .success-sub   { font-size:.76rem; color:var(--text-light); margin-top:4px; }

  /* Error */
  .err { font-size:.75rem; color:#a93226; padding:7px 11px; background:#fdf0ee; border-radius:6px; border-left:3px solid #c0392b; margin-bottom:8px; display:none; }

  /* Toast */
  #toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--brown-dark); color:var(--cream); padding:10px 22px; border-radius:30px; font-size:.82rem; box-shadow:var(--shadow-md); transition:transform .3s ease; z-index:999; white-space:nowrap; pointer-events:none; }
  #toast.show { transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div id="app">

  <nav class="topnav">
    <a class="topnav-brand" href="Main.html">
      <span style="color:#fff;font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;">Live</span><span style="color:#f7e7b5;font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;">Kitaab</span>
    </a>
    <div class="topnav-links">
      <a href="Main.html">Library</a>
      <a href="Reader.html">Reader</a>
      <a href="Account.html" class="btn-account">Account</a>
    </div>
  </nav>

  <div class="banner">
    <div class="banner-icon">üìñ</div>
    <div class="banner-text">
      <h1>Discover Your Next Story</h1>
      <p>Curated fiction ‚Äî novels, novellas &amp; short stories</p>
    </div>
  </div>

  <div class="filter-bar">
    <span class="filter-label">Filter</span>
    <button class="chip" id="freeChip" onclick="toggleFree()">üíé Free Only</button>
    <div class="filter-spacer"></div>
    <span id="statusText">Loading library‚Ä¶</span>
  </div>

  <div class="tab-strip">
    <button class="tab-btn active" onclick="switchTab('novels',this)">üìñ Novels</button>
    <button class="tab-btn" onclick="switchTab('novellas',this)">üìò Novellas</button>
    <button class="tab-btn" onclick="switchTab('shorts',this)">üìù Short Stories</button>
  </div>

  <div id="panel-novels"   class="tab-panel active"><div class="book-grid" id="grid-novels"></div></div>
  <div id="panel-novellas" class="tab-panel"><div class="book-grid" id="grid-novellas"></div></div>
  <div id="panel-shorts"   class="tab-panel"><div class="book-grid" id="grid-shorts"></div></div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PURCHASE MODAL
     Panels: pay ‚Üí utr ‚Üí verifying ‚Üí success
     Author passkey toggles in place of UTR panel
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="purchaseModal">
  <div class="modal">

    <div class="modal-title" id="pm-title"></div>
    <div class="modal-sub"   id="pm-sub"></div>

    <!-- Step indicator -->
    <div class="steps" id="pm-steps">
      <div class="scol"><div class="sdot on" id="sd1">1</div><div class="slabel">Pay</div></div>
      <div class="sline" id="sl1"></div>
      <div class="scol"><div class="sdot"    id="sd2">2</div><div class="slabel">Confirm</div></div>
      <div class="sline" id="sl2"></div>
      <div class="scol"><div class="sdot"    id="sd3">3</div><div class="slabel">Read</div></div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL 1: QR PAYMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="pp-pay">
      <div class="qr-box">
        <div class="qr-eyebrow">üì∑ Open your UPI app ‚Üí Scan QR ‚Üí Pay</div>
        <div id="qrcode"></div>
        <div class="amount-pill" id="pm-amount">‚Çπ‚Äì</div>
        <div class="upi-row">
          <span class="upi-chip" id="pm-upi-text"></span>
          <button class="copy-btn" onclick="copyUPI()">Copy</button>
        </div>
        <div class="app-chips">
          <span class="app-chip">GPay</span>
          <span class="app-chip">PhonePe</span>
          <span class="app-chip">Paytm</span>
          <span class="app-chip">BHIM</span>
          <span class="app-chip">Any UPI</span>
        </div>
      </div>
      <p style="font-size:.75rem;color:var(--text-mid);text-align:center;line-height:1.6;margin-bottom:4px;">
        After paying, tap <strong>I've Paid ‚Üí</strong> and enter your Transaction ID.
      </p>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('purchaseModal')">Cancel</button>
        <button class="btn btn-green" onclick="showPanel('utr')">I've Paid ‚Üí</button>
      </div>
      <div class="author-toggle" onclick="showPanel('author')">‚úçÔ∏è I'm the author of this book</div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL 2: UTR ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="pp-utr" style="display:none">
      <div class="info-box green">
        <div class="ibox-title green">‚úÖ Enter your Transaction ID (UTR)</div>
        <div class="ibox-body">
          Every UPI payment gives you a <strong>Transaction / Reference ID</strong>.
          Enter it below ‚Äî it proves your payment went through.
          <div class="ibox-where">
            <strong>Where to find it:</strong><br>
            ‚Ä¢ <strong>GPay</strong> ‚Üí tap the payment ‚Üí "Transaction ID"<br>
            ‚Ä¢ <strong>PhonePe</strong> ‚Üí History ‚Üí tap payment ‚Üí "UTR No."<br>
            ‚Ä¢ <strong>Paytm</strong> ‚Üí Passbook ‚Üí tap payment ‚Üí "Bank Ref. No"<br>
            ‚Ä¢ <strong>BHIM / others</strong> ‚Üí History ‚Üí tap transaction
          </div>
        </div>
      </div>
      <input class="field" id="pm-utr" type="text"
             placeholder="e.g. 421831092847"
             maxlength="22" autocomplete="off"
             oninput="this.value=this.value.replace(/[^0-9A-Za-z]/g,'').toUpperCase()"
             onkeydown="if(event.key==='Enter')verifyUTR()">
      <div class="err" id="utr-err"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="showPanel('pay')">‚Üê Back</button>
        <button class="btn btn-green" onclick="verifyUTR()">Verify &amp; Unlock ‚Üí</button>
      </div>
      <div class="author-toggle" onclick="showPanel('author')">‚úçÔ∏è I'm the author of this book</div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL 3: VERIFYING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="pp-verifying" style="display:none">
      <div class="spinner-wrap">
        <div class="spinner"></div>
        <div class="spinner-label">Verifying payment‚Ä¶</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL 4: SUCCESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="pp-success" style="display:none">
      <div class="success-wrap">
        <div class="success-emoji">üéâ</div>
        <div class="success-title">Payment Verified!</div>
        <div class="success-sub">Opening your book‚Ä¶</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL 5: AUTHOR PASSKEY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="pp-author" style="display:none">
      <div class="info-box gold">
        <div class="ibox-title gold">‚úçÔ∏è Author Passkey</div>
        <div class="ibox-body">
          Enter the passkey you received from the Livekitaab team when your book was published.
          This unlocks the book for you at no charge.
        </div>
      </div>
      <input class="field" id="pm-authorkey" type="text"
             placeholder="Your author passkey‚Ä¶"
             autocomplete="off"
             onkeydown="if(event.key==='Enter')verifyAuthorKey()">
      <div class="err" id="author-err"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="showPanel('pay')">‚Üê Back</button>
        <button class="btn btn-gold"  onclick="verifyAuthorKey()">üîì Unlock as Author</button>
      </div>
    </div>

  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LIBRARY_URL = 'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/library.json';
const API_URL     = 'https://web-production-a6ac9.up.railway.app';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FALLBACK (matches your real library.json structure)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FALLBACK_BOOKS = [
  { id:'somoyer', title:'Somoyer Chabikathi', type:'novel', price:0, author:'Team Livekitaab',
    cover:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Cover.png',
    file:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Books/Test.clbk',
    upi_id:'arohanchatterjee881@okicici', author_key:'LIVEKITAAB-SOMOYER-2024' },
  { id:'ordhek_payer_chap', title:'Ordhek Payer Chap', type:'novella', price:30, author:'Panpriyo Nondi',
    cover:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Payer Chap Cover.png',
    file:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Books/JS.lbk',
    upi_id:'arohanchatterjee881@okicici', author_key:'NONDI-PAYER-CHAP-2024' },
  { id:'Ek_Muhurter_Sporsho', title:'Ek Muhurter Sporsho', type:'short_story', price:1, author:'Shubhankar Babu',
    cover:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Cover2.png',
    file:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Books/EMS.lbk',
    upi_id:'arohanchatterjee881@okicici', author_key:'BABU-EMS-2024' },
  { id:'Jontrer_Songsar', title:'Poripati Jontrer Songsar', type:'short_story', price:1, author:'Shubhankar Babu',
    cover:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Cover1.png',
    file:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Books/JS.lbk',
    upi_id:'arohanchatterjee881@okicici', author_key:'BABU-JS-2024' }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allBooks    = [];
let filterFree  = false;
let pendingBook = null;
let ownedIds    = JSON.parse(localStorage.getItem('lk_owned') || '[]');
let usedUTRs    = JSON.parse(localStorage.getItem('lk_utrs')  || '[]');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _base = (() => { const p=window.location.pathname; return p.substring(0,p.lastIndexOf('/')); })();
function nav(page) { window.location.href = _base+'/'+page; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', async () => {
  try {
    const r = await fetch(LIBRARY_URL);
    const j = await r.json();
    allBooks = j.books || FALLBACK_BOOKS;
  } catch { allBooks = FALLBACK_BOOKS; }
  renderLibrary();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLibrary() {
  const map = { novels:'novel', novellas:'novella', shorts:'short_story' };
  let shown = 0;
  for (const [key, type] of Object.entries(map)) {
    const grid = document.getElementById('grid-'+key);
    const list = allBooks.filter(b => b.type===type && (!filterFree || b.price===0));
    grid.innerHTML = '';
    if (!list.length) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><span>üåø</span>No ${key} found.</div>`;
    } else {
      list.forEach(b => grid.appendChild(makeCard(b)));
      shown += list.length;
    }
  }
  document.getElementById('statusText').textContent =
    `${shown} book${shown!==1?'s':''} available${filterFree?' (free only)':''}`;
}

function makeCard(book) {
  const owned  = ownedIds.includes(book.id);
  const isFree = book.price === 0;
  const hasFile= !!(book.file);
  const canRead= hasFile && (isFree || owned);

  const card = document.createElement('div');
  card.className = 'book-card';

  // Cover
  const cw = document.createElement('div'); cw.className = 'cover-wrap';
  if (book.cover) {
    const img = document.createElement('img');
    img.className='book-cover'; img.src=book.cover; img.alt=book.title; img.loading='lazy';
    img.onerror = () => { cw.innerHTML='<div class="book-cover-placeholder">üìï</div>'; };
    cw.appendChild(img);
  } else { cw.innerHTML='<div class="book-cover-placeholder">üìï</div>'; }
  const badge = document.createElement('span');
  badge.className = 'book-badge '+(isFree?'badge-free':'badge-paid');
  badge.textContent = isFree ? 'Free' : '‚Çπ'+book.price;
  cw.appendChild(badge);

  // Info
  const info = document.createElement('div'); info.className='book-info';
  info.innerHTML = `<div class="book-title">${esc(book.title)}</div><div class="book-author">${esc(book.author||'')}</div>`;

  // Action button
  const ac = document.createElement('div'); ac.className='book-action';
  const btn = document.createElement('button'); btn.className='btn';
  if (canRead) {
    btn.className+=' btn-read'; btn.innerHTML='üìñ Read'; btn.onclick=()=>openReader(book);
  } else if (!isFree && !owned) {
    btn.className+=' btn-buy'; btn.innerHTML=`üõí Buy ‚Çπ${book.price}`; btn.onclick=()=>openPurchase(book);
  } else {
    btn.className+=' btn-muted'; btn.innerHTML='Coming Soon'; btn.disabled=true; btn.style.opacity='.5'; btn.style.cursor='default';
  }
  ac.appendChild(btn);

  card.appendChild(cw); card.appendChild(info); card.appendChild(ac);
  return card;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABS / FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(key, el) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-'+key).classList.add('active');
}
function toggleFree() {
  filterFree = !filterFree;
  const c = document.getElementById('freeChip');
  c.classList.toggle('active', filterFree);
  c.textContent = filterFree ? '‚ú® Show All' : 'üíé Free Only';
  renderLibrary();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OPEN PURCHASE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPurchase(book) {
  pendingBook = book;
  document.getElementById('pm-title').textContent = book.title;
  document.getElementById('pm-sub').textContent   = `‚Çπ${book.price} ¬∑ one-time purchase`;

  const upiId  = book.upi_id || 'yourname@upi';
  const amount = book.price;

  // UPI URL ‚Äî ONLY used inside the QR image, never as a page redirect
  const upiUrl = `upi://pay?pa=${enc(upiId)}&pn=${enc('Livekitaab')}&am=${amount}&cu=INR&tn=${enc('Livekitaab: '+book.title)}`;

  document.getElementById('pm-amount').textContent   = `‚Çπ${amount}`;
  document.getElementById('pm-upi-text').textContent = upiId;

  // Draw QR
  const el = document.getElementById('qrcode');
  el.innerHTML = '';
  new QRCode(el, { text:upiUrl, width:172, height:172, colorDark:'#3b2010', colorLight:'#ffffff', correctLevel:QRCode.CorrectLevel.M });

  showPanel('pay');
  openModal('purchaseModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PANEL SYSTEM
//  Panels: pay | utr | verifying | success | author
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PANELS = ['pay','utr','verifying','success','author'];

function showPanel(name) {
  PANELS.forEach(p => document.getElementById('pp-'+p).style.display = 'none');
  document.getElementById('pp-'+name).style.display = 'block';
  document.getElementById('pm-steps').style.display = ['verifying','success','author'].includes(name) ? 'none' : 'flex';

  // Step dot states
  const states = { pay:[1,[],[]], utr:[2,[1],[]], verifying:[3,[1,2],[]], success:[null,[1,2,3],[]] };
  const s = states[name];
  if (s) {
    [1,2,3].forEach(i => {
      const d = document.getElementById('sd'+i);
      if (s[2].includes(i))      { d.className='sdot ok';  d.textContent='‚úì'; }
      else if (s[0]===i)         { d.className='sdot on';  d.textContent=i; }
      else                       { d.className='sdot';     d.textContent=i; }
    });
    document.getElementById('sl1').className = 'sline'+(s[1].includes(1)?' ok':'');
    document.getElementById('sl2').className = 'sline'+(s[1].includes(2)?' ok':'');
  }

  // Auto-focus inputs
  if (name==='utr')    { document.getElementById('pm-utr').value='';       document.getElementById('utr-err').style.display='none';    setTimeout(()=>document.getElementById('pm-utr').focus(),60); }
  if (name==='author') { document.getElementById('pm-authorkey').value=''; document.getElementById('author-err').style.display='none'; setTimeout(()=>document.getElementById('pm-authorkey').focus(),60); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTR VERIFICATION
//
//  Your Railway backend should handle:
//  POST /verify-utr
//  Body: { utr, book_id, amount, upi_id }
//  Return: { verified: true } or { verified: false, reason: "..." }
//
//  If the endpoint isn't ready yet, see the catch block below ‚Äî
//  UTRs are logged to /log-utr for manual admin approval.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Polling state
let _pollInterval = null;
let _pendingVerificationCode = null;

async function verifyUTR() {
  const utr   = document.getElementById('pm-utr').value.trim().toUpperCase();
  const errEl = document.getElementById('utr-err');
  errEl.style.display = 'none';

  if (utr.length < 10) {
    errEl.textContent = 'Please enter a valid Transaction ID (at least 10 characters).';
    errEl.style.display = 'block'; return;
  }
  if (usedUTRs.includes(utr)) {
    errEl.textContent = 'This Transaction ID has already been used.';
    errEl.style.display = 'block'; return;
  }

  showPanel('verifying');
  document.querySelector('#pp-verifying .spinner-label').textContent = 'Submitting payment‚Ä¶';

  try {
    const res  = await fetch(`${API_URL}/api/request-purchase`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ book_id: pendingBook.id, price: pendingBook.price, transaction_id: utr })
    });
    const data = await res.json();

    if (data.error) {
      showPanel('utr');
      const e = document.getElementById('utr-err');
      e.textContent = data.error === 'Transaction ID already used'
        ? 'This Transaction ID has already been submitted.'
        : (data.error || 'Submission failed. Please try again.');
      e.style.display = 'block';
      return;
    }

    // Submitted ‚Äî now poll for admin approval
    _pendingVerificationCode = data.verification_code;
    usedUTRs.push(utr);
    localStorage.setItem('lk_utrs', JSON.stringify(usedUTRs));

    document.querySelector('#pp-verifying .spinner-label').innerHTML =
      'Payment submitted ‚úì<br><small style="color:var(--text-light);font-size:.72rem;">Waiting for approval ‚Äî usually a few minutes.</small>';

    if (_pollInterval) clearInterval(_pollInterval);
    _pollInterval = setInterval(() => pollApproval(pendingBook), 5000);

  } catch (e) {
    showPanel('utr');
    const e2 = document.getElementById('utr-err');
    e2.textContent = 'Could not reach server. Check your connection and try again.';
    e2.style.display = 'block';
  }
}

async function pollApproval(book) {
  if (!_pendingVerificationCode) return;
  try {
    const res  = await fetch(`${API_URL}/api/poll-purchase`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ verification_code: _pendingVerificationCode, book_id: book.id })
    });
    const data = await res.json();
    if (data.approved) {
      clearInterval(_pollInterval); _pollInterval = null; _pendingVerificationCode = null;
      unlockBook(book);
    }
  } catch { /* retry next tick */ }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTHOR PASSKEY
//
//  How to set up:
//  In library.json, add to any book:
//    "author_key": "WHATEVER-YOU-CHOOSE"
//  Give that exact string to the author.
//  They type it here ‚Üí instant free unlock.
//  Change the key anytime by updating library.json.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function verifyAuthorKey() {
  const input  = document.getElementById('pm-authorkey').value.trim();
  const errEl  = document.getElementById('author-err');
  errEl.style.display = 'none';

  if (!input) {
    errEl.textContent = 'Please enter your author passkey.';
    errEl.style.display = 'block'; return;
  }

  // Simple direct string comparison ‚Äî no hashing, no external tools
  const correct = pendingBook.author_key || '';

  if (!correct) {
    errEl.textContent = 'No author passkey has been set for this book yet. Contact the Livekitaab team.';
    errEl.style.display = 'block'; return;
  }

  if (input === correct) {
    unlockBook(pendingBook);
  } else {
    errEl.textContent = 'Incorrect passkey. Check for typos, or contact the Livekitaab team.';
    errEl.style.display = 'block';
    document.getElementById('pm-authorkey').select();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UNLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function unlockBook(book) {
  if (!ownedIds.includes(book.id)) {
    ownedIds.push(book.id);
    localStorage.setItem('lk_owned', JSON.stringify(ownedIds));
  }
  showPanel('success');
  renderLibrary();
  setTimeout(() => { closeModal('purchaseModal'); openReader(book); }, 1500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  READER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CORS_PROXY = 'https://your-proxy.YOUR-SUBDOMAIN.workers.dev';

function normaliseLbkUrl(url) {
  if (!url) return url;
  if (/raw\.githubusercontent\.com/i.test(url)) return url;
  const m = url.match(/github\.com\/([^/]+)\/([^/]+)\/blob\/([^/]+)\/(.+)/i);
  if (m) return `https://raw.githubusercontent.com/${m[1]}/${m[2]}/${m[3]}/${m[4]}`;
  if (/github\.com\/[^/]+\/[^/]+\/releases\/download\//i.test(url)) {
    const ok = CORS_PROXY && !CORS_PROXY.includes('YOUR-SUBDOMAIN');
    return ok ? `${CORS_PROXY}?url=${enc(url)}` : url;
  }
  return url;
}

function openReader(book) {
  const file = normaliseLbkUrl(book.file || '');
  sessionStorage.setItem('pending_book', JSON.stringify({...book, file: file||book.file}));
  nav('Reader.html');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COPY UPI ID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyUPI() {
  const id = document.getElementById('pm-upi-text').textContent;
  navigator.clipboard.writeText(id).then(()=>toast('UPI ID copied!')).catch(()=>{});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

let _tt;
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(_tt); _tt = setTimeout(()=>t.classList.remove('show'), 2600);
}

function enc(s) { return encodeURIComponent(s); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
