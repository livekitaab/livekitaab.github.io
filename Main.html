<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LiveKitaab â€” Book Library</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Lora:ital,wght@0,400;0,500;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  :root {
    --brown:       #a46636;
    --brown-deep:  #7a4a22;
    --brown-dark:  #3b2010;
    --green:       #6bbf8e;
    --green-light: #a2d5a1;
    --green-dark:  #3d7a56;
    --cream:       #f6e9d7;
    --cream-dark:  #ecdcc4;
    --cream-deeper:#e0cdb0;
    --gold:        #f7e7b5;
    --gold-deep:   #d4a853;
    --text-dark:   #2a1a0e;
    --text-mid:    #5c3d1e;
    --text-light:  #8c6a45;
    --shadow-sm:   0 2px 8px rgba(58,28,8,.10);
    --shadow-md:   0 4px 20px rgba(58,28,8,.14);
    --shadow-lg:   0 8px 40px rgba(58,28,8,.22);
    --radius:      12px;
    --radius-sm:   8px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body { font-family:'DM Sans',sans-serif; background:var(--cream); color:var(--text-dark); min-height:100vh; overflow-x:hidden; }
  body::before { content:''; position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.035; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E"); }
  #app { position:relative; z-index:1; display:flex; flex-direction:column; min-height:100vh; }

  /* â”€â”€ Nav â”€â”€ */
  .topnav { background:var(--brown-dark); padding:0 24px; height:52px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 10px rgba(0,0,0,.35); position:sticky; top:0; z-index:100; }
  .topnav-brand { font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:700; color:var(--gold); letter-spacing:.02em; text-decoration:none; }
  .topnav-links { display:flex; gap:6px; align-items:center; }
  .topnav-links a { color:var(--cream); font-size:.82rem; text-decoration:none; padding:5px 12px; border-radius:20px; transition:background .2s,color .2s; }
  .topnav-links a:hover { background:rgba(246,233,215,.12); color:var(--gold); }
  .topnav-links .btn-account { background:var(--green); color:var(--brown-dark); font-weight:500; padding:5px 16px; }
  .topnav-links .btn-account:hover { background:var(--green-light); }

  /* â”€â”€ Banner â”€â”€ */
  .banner { background:linear-gradient(120deg,var(--green) 0%,var(--green-light) 55%,var(--gold-deep) 100%); padding:36px 32px 32px; display:flex; align-items:center; gap:20px; position:relative; overflow:hidden; }
  .banner::after { content:'ğŸ“š'; position:absolute; right:-10px; bottom:-18px; font-size:110px; opacity:.10; pointer-events:none; transform:rotate(-8deg); }
  .banner-icon { font-size:2.6rem; flex-shrink:0; filter:drop-shadow(0 2px 6px rgba(0,0,0,.15)); }
  .banner-text h1 { font-family:'Playfair Display',serif; font-size:clamp(1.5rem,4vw,2rem); font-weight:900; color:var(--brown-dark); line-height:1.15; }
  .banner-text p { font-family:'Lora',serif; font-style:italic; color:var(--brown-deep); font-size:.9rem; margin-top:5px; }

  /* â”€â”€ Filter bar â”€â”€ */
  .filter-bar { background:var(--cream-dark); border-bottom:1.5px solid var(--cream-deeper); padding:10px 20px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .filter-label { font-size:.78rem; font-weight:500; color:var(--text-light); text-transform:uppercase; letter-spacing:.08em; margin-right:4px; }
  .chip { display:inline-flex; align-items:center; gap:5px; padding:4px 14px; border-radius:20px; font-size:.8rem; cursor:pointer; transition:all .2s; border:1.5px solid var(--brown); color:var(--brown); background:transparent; font-family:'DM Sans',sans-serif; white-space:nowrap; }
  .chip.active { background:var(--green); border-color:var(--green); color:var(--brown-dark); font-weight:500; }
  .chip:hover:not(.active) { background:rgba(164,102,54,.07); }
  .filter-spacer { flex:1; }
  #statusText { font-size:.78rem; color:var(--text-light); font-style:italic; }

  /* â”€â”€ Tab strip â”€â”€ */
  .tab-strip { display:flex; background:var(--brown-dark); border-bottom:2px solid rgba(164,102,54,.35); position:sticky; top:52px; z-index:90; }
  .tab-btn { flex:1; padding:13px 8px; text-align:center; font-family:'DM Sans',sans-serif; font-size:.84rem; font-weight:500; color:rgba(246,233,215,.55); cursor:pointer; border:none; background:transparent; transition:all .2s; border-bottom:3px solid transparent; margin-bottom:-2px; white-space:nowrap; }
  .tab-btn.active { color:var(--gold); border-bottom-color:var(--gold-deep); }
  .tab-btn:hover:not(.active) { color:var(--cream); background:rgba(246,233,215,.06); }

  /* â”€â”€ Shelf panels â”€â”€ */
  .tab-panel { display:none; padding:28px 16px 80px; animation:fadeIn .2s ease;
    background: repeating-linear-gradient(180deg,rgba(0,0,0,0) 0px,rgba(0,0,0,0) 17px,rgba(0,0,0,.05) 17px,rgba(0,0,0,.05) 18px,rgba(255,255,255,.03) 18px,rgba(255,255,255,.03) 19px,rgba(0,0,0,0) 19px,rgba(0,0,0,0) 36px),
    linear-gradient(172deg,#5c2e10 0%,#7a4422 20%,#a46636 40%,#8b5530 58%,#7a4422 75%,#5c2e10 100%);
    box-shadow:inset 0 8px 20px rgba(0,0,0,.30),inset 0 -4px 10px rgba(0,0,0,.20); min-height:280px; }
  .tab-panel.active { display:block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  /* â”€â”€ Book grid â”€â”€ */
  .book-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(155px,1fr)); gap:18px; }
  .empty-state { text-align:center; padding:60px 20px; color:var(--gold); font-family:'Lora',serif; font-style:italic; font-size:1rem; text-shadow:0 1px 3px rgba(0,0,0,.4); }
  .empty-state span { display:block; font-size:2.5rem; margin-bottom:12px; }

  /* â”€â”€ Book card â”€â”€ */
  .book-card { background:var(--cream); border-radius:var(--radius); box-shadow:0 6px 18px rgba(0,0,0,.40),0 2px 4px rgba(0,0,0,.22); overflow:hidden; cursor:pointer; transition:transform .22s ease,box-shadow .22s ease; display:flex; flex-direction:column; }
  .book-card:hover { transform:translateY(-8px) scale(1.02); box-shadow:0 18px 36px rgba(0,0,0,.50),0 4px 8px rgba(0,0,0,.28); }
  .book-cover { width:100%; aspect-ratio:2/3; object-fit:cover; display:block; background:linear-gradient(135deg,var(--brown) 0%,var(--brown-deep) 100%); }
  .cover-wrap { position:relative; }
  .book-cover-placeholder { width:100%; aspect-ratio:2/3; background:linear-gradient(135deg,var(--brown) 0%,var(--brown-deep) 100%); display:flex; align-items:center; justify-content:center; font-size:2.4rem; color:var(--gold); opacity:.7; }
  .book-badge { position:absolute; top:8px; right:8px; padding:2px 8px; border-radius:10px; font-size:.65rem; font-weight:600; letter-spacing:.04em; text-transform:uppercase; }
  .badge-free { background:var(--green); color:var(--brown-dark); }
  .badge-paid { background:var(--gold-deep); color:var(--brown-dark); }
  .book-info { padding:10px 10px 0; flex:1; }
  .book-title { font-family:'Playfair Display',serif; font-size:.88rem; font-weight:600; color:var(--text-dark); line-height:1.35; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .book-author { font-family:'Lora',serif; font-style:italic; font-size:.72rem; color:var(--text-light); margin-top:3px; }
  .book-action { padding:8px 10px 10px; }
  .btn { width:100%; padding:7px; border:none; border-radius:var(--radius-sm); font-family:'DM Sans',sans-serif; font-size:.78rem; font-weight:500; cursor:pointer; transition:all .18s; display:flex; align-items:center; justify-content:center; gap:5px; text-decoration:none; }
  .btn-read { background:var(--green); color:var(--brown-dark); }
  .btn-read:hover { background:var(--green-dark); color:white; }
  .btn-buy { background:var(--brown); color:var(--cream); }
  .btn-buy:hover { background:var(--brown-deep); }
  .btn-owned { background:var(--cream-dark); color:var(--text-mid); border:1.5px solid var(--cream-deeper); }

  /* â”€â”€ Modal â”€â”€ */
  .modal-overlay { position:fixed; inset:0; z-index:200; background:rgba(42,26,14,.60); backdrop-filter:blur(5px); display:flex; align-items:center; justify-content:center; padding:16px; opacity:0; pointer-events:none; transition:opacity .22s; }
  .modal-overlay.open { opacity:1; pointer-events:all; }
  .modal { background:var(--cream); border-radius:var(--radius); box-shadow:var(--shadow-lg); padding:26px 22px; width:100%; max-width:420px; transform:translateY(18px) scale(.98); transition:transform .22s ease; max-height:94vh; overflow-y:auto; }
  .modal-overlay.open .modal { transform:translateY(0) scale(1); }
  .modal h2 { font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--text-dark); margin-bottom:3px; }
  .modal-sub { font-size:.8rem; color:var(--text-light); margin-bottom:0; }
  .modal-divider { height:1px; background:var(--cream-deeper); margin:14px 0; }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-top:14px; }
  .modal-actions .btn { width:auto; padding:8px 18px; font-size:.8rem; }
  .btn-ghost { background:transparent; color:var(--text-light); border:1.5px solid var(--cream-deeper); }
  .btn-ghost:hover { background:var(--cream-dark); }
  .btn-green { background:var(--green); color:var(--brown-dark); font-weight:600; }
  .btn-green:hover { background:var(--green-dark); color:white; }
  .btn-brown { background:var(--brown); color:var(--cream); }
  .btn-brown:hover { background:var(--brown-deep); }
  .modal-input { width:100%; padding:9px 12px; border-radius:var(--radius-sm); border:1.5px solid var(--cream-deeper); background:white; font-family:'DM Sans',sans-serif; font-size:.85rem; color:var(--text-dark); outline:none; transition:border-color .18s; margin-bottom:8px; }
  .modal-input:focus { border-color:var(--green); }
  .modal-input::placeholder { color:var(--text-light); }

  /* â”€â”€ Step indicator â”€â”€ */
  .steps-row { display:flex; align-items:center; margin:14px 0 16px; }
  .step-dot { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.72rem; font-weight:700; flex-shrink:0; transition:all .3s; background:var(--cream-deeper); color:var(--text-light); }
  .step-dot.active { background:var(--brown); color:white; box-shadow:0 0 0 3px rgba(164,102,54,.2); }
  .step-dot.done { background:var(--green); color:var(--brown-dark); }
  .step-line { flex:1; height:2px; background:var(--cream-deeper); transition:background .3s; }
  .step-line.done { background:var(--green); }
  .step-label { font-size:.65rem; text-align:center; margin-top:4px; color:var(--text-light); white-space:nowrap; }
  .step-col { display:flex; flex-direction:column; align-items:center; }

  /* â”€â”€ QR box â”€â”€ */
  .qr-box { background:white; border-radius:var(--radius); border:2px solid var(--cream-deeper); padding:16px; text-align:center; margin-bottom:10px; }
  .qr-label { font-size:.68rem; text-transform:uppercase; letter-spacing:.08em; color:var(--text-light); font-weight:600; margin-bottom:10px; }
  #qrcode { display:inline-block; line-height:0; border-radius:6px; overflow:hidden; }
  #qrcode canvas, #qrcode img { display:block; border-radius:4px; }
  .qr-amount-pill { display:inline-block; margin-top:10px; background:var(--gold); color:var(--brown-dark); font-family:'Playfair Display',serif; font-size:1.15rem; font-weight:700; padding:4px 20px; border-radius:20px; border:1.5px solid var(--gold-deep); }
  .qr-upi-row { margin-top:7px; display:flex; align-items:center; justify-content:center; gap:6px; flex-wrap:wrap; }
  .qr-upi-chip { font-size:.7rem; font-family:monospace; background:var(--cream-dark); color:var(--text-mid); padding:3px 10px; border-radius:6px; }
  .copy-btn { font-size:.67rem; padding:3px 9px; border-radius:6px; border:1px solid var(--cream-deeper); background:white; color:var(--text-mid); cursor:pointer; font-family:'DM Sans',sans-serif; transition:all .15s; }
  .copy-btn:hover { background:var(--cream-dark); }
  .qr-apps { display:flex; gap:5px; justify-content:center; flex-wrap:wrap; margin-top:8px; }
  .qr-app { font-size:.65rem; padding:2px 8px; border-radius:8px; background:var(--cream-dark); color:var(--text-mid); border:1px solid var(--cream-deeper); }

  /* â”€â”€ Same-phone pay button â”€â”€ */
  .pay-phone-btn { display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:11px; border-radius:var(--radius-sm); background:linear-gradient(135deg,#2d6a4f,#3d7a56); color:white; font-family:'DM Sans',sans-serif; font-size:.84rem; font-weight:600; text-decoration:none; margin-top:8px; border:none; cursor:pointer; transition:all .2s; box-shadow:0 3px 10px rgba(61,122,86,.35); }
  .pay-phone-btn:hover { background:linear-gradient(135deg,#1e4d38,#2d6a4f); box-shadow:0 5px 16px rgba(61,122,86,.45); transform:translateY(-1px); }
  .or-divider { display:flex; align-items:center; gap:8px; margin:10px 0; font-size:.7rem; color:var(--text-light); }
  .or-divider::before, .or-divider::after { content:''; flex:1; height:1px; background:var(--cream-deeper); }

  /* â”€â”€ UTR step â”€â”€ */
  .utr-box { background:linear-gradient(135deg,rgba(107,191,142,.10),rgba(107,191,142,.04)); border:1.5px solid rgba(107,191,142,.35); border-radius:var(--radius-sm); padding:14px; margin-bottom:10px; }
  .utr-box-title { font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.07em; color:var(--green-dark); margin-bottom:8px; display:flex; align-items:center; gap:5px; }
  .utr-help { font-size:.74rem; color:var(--text-mid); line-height:1.55; margin-bottom:10px; }
  .utr-help strong { color:var(--text-dark); }
  .utr-where { font-size:.7rem; color:var(--text-light); background:var(--cream-dark); border-radius:6px; padding:7px 10px; line-height:1.6; margin-bottom:10px; }

  /* â”€â”€ Author passkey link â”€â”€ */
  .author-link { font-size:.7rem; color:var(--text-light); text-align:center; margin-top:10px; cursor:pointer; text-decoration:underline dotted; transition:color .15s; }
  .author-link:hover { color:var(--brown); }

  /* â”€â”€ Author passkey panel â”€â”€ */
  .author-box { background:linear-gradient(135deg,rgba(212,168,83,.12),rgba(212,168,83,.04)); border:1.5px solid rgba(212,168,83,.4); border-radius:var(--radius-sm); padding:14px; margin-bottom:10px; }
  .author-box-title { font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.07em; color:var(--gold-deep); margin-bottom:6px; }

  /* â”€â”€ Verifying spinner â”€â”€ */
  .verify-state { text-align:center; padding:24px 0; }
  .spinner { width:36px; height:36px; border:3px solid var(--cream-deeper); border-top-color:var(--green); border-radius:50%; animation:spin .8s linear infinite; margin:0 auto 12px; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .verify-text { font-size:.85rem; color:var(--text-mid); }

  /* â”€â”€ Success state â”€â”€ */
  .success-state { text-align:center; padding:20px 0 10px; }
  .success-icon { font-size:3rem; margin-bottom:10px; animation:pop .4s ease; }
  @keyframes pop { 0%{transform:scale(0)} 80%{transform:scale(1.15)} 100%{transform:scale(1)} }
  .success-title { font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--text-dark); margin-bottom:5px; }
  .success-sub { font-size:.78rem; color:var(--text-light); }

  /* â”€â”€ Error box â”€â”€ */
  .err-box { font-size:.76rem; color:#b03a2e; padding:7px 12px; background:#fdf0ee; border-radius:6px; border-left:3px solid #b03a2e; margin-bottom:8px; display:none; }

  /* â”€â”€ Toast â”€â”€ */
  #toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--brown-dark); color:var(--cream); padding:10px 22px; border-radius:30px; font-size:.82rem; box-shadow:var(--shadow-md); transition:transform .3s ease; z-index:999; white-space:nowrap; }
  #toast.show { transform:translateX(-50%) translateY(0); }

  /* â”€â”€ Progress â”€â”€ */
  .progress-track { width:100%; height:8px; background:var(--cream-deeper); border-radius:4px; overflow:hidden; margin:12px 0; }
  .progress-fill { height:100%; background:linear-gradient(90deg,var(--green),var(--green-dark)); border-radius:4px; width:0%; transition:width .3s ease; }
</style>
</head>
<body>
<div id="app">

  <nav class="topnav">
    <a class="topnav-brand" href="Main.html">
      <span style="color:#fff;font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;">Live</span><span style="color:#f7e7b5;font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;">Kitaab</span>
    </a>
    <div class="topnav-links">
      <a href="Main.html">Library</a>
      <a href="Reader.html">Reader</a>
      <a href="Account.html" class="btn-account">Account</a>
    </div>
  </nav>

  <div class="banner">
    <div class="banner-icon">ğŸ“–</div>
    <div class="banner-text">
      <h1>Discover Your Next Story</h1>
      <p>Curated fiction â€” novels, novellas &amp; short stories</p>
    </div>
  </div>

  <div class="filter-bar">
    <span class="filter-label">Filter</span>
    <button class="chip" id="freeChip" onclick="toggleFree()">ğŸ’ Free Only</button>
    <div class="filter-spacer"></div>
    <span id="statusText">Loading libraryâ€¦</span>
  </div>

  <div class="tab-strip">
    <button class="tab-btn active" onclick="switchTab('novels',this)">ğŸ“– Novels</button>
    <button class="tab-btn" onclick="switchTab('novellas',this)">ğŸ“˜ Novellas</button>
    <button class="tab-btn" onclick="switchTab('shorts',this)">ğŸ“ Short Stories</button>
  </div>

  <div id="panel-novels"   class="tab-panel active"><div class="book-grid" id="grid-novels"></div></div>
  <div id="panel-novellas" class="tab-panel"><div class="book-grid" id="grid-novellas"></div></div>
  <div id="panel-shorts"   class="tab-panel"><div class="book-grid" id="grid-shorts"></div></div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PURCHASE MODAL
     Panels: pay â†’ utr â†’ (verifying) â†’ success / author-key
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="purchaseModal">
  <div class="modal">

    <h2 id="pm-title">Purchase Book</h2>
    <p class="modal-sub" id="pm-sub"></p>

    <!-- Step indicator (hidden in author/success/verifying states) -->
    <div class="steps-row" id="pm-steps">
      <div class="step-col">
        <div class="step-dot active" id="sd1">1</div>
        <div class="step-label">Pay</div>
      </div>
      <div class="step-line" id="sl1"></div>
      <div class="step-col">
        <div class="step-dot" id="sd2">2</div>
        <div class="step-label">Confirm</div>
      </div>
      <div class="step-line" id="sl2"></div>
      <div class="step-col">
        <div class="step-dot" id="sd3">3</div>
        <div class="step-label">Unlock</div>
      </div>
    </div>

    <!-- â”€â”€ PANEL: PAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="panel-pay">
      <div class="qr-box">
        <div class="qr-label">ğŸ“· Scan with any UPI app (other device)</div>
        <div id="qrcode"></div>
        <div class="qr-amount-pill" id="pm-amount">â‚¹â€“</div>
        <div class="qr-upi-row">
          <span class="qr-upi-chip" id="pm-upi-show"></span>
          <button class="copy-btn" onclick="copyUPI()">Copy ID</button>
        </div>
        <div class="qr-apps">
          <span class="qr-app">GPay</span>
          <span class="qr-app">PhonePe</span>
          <span class="qr-app">Paytm</span>
          <span class="qr-app">BHIM</span>
          <span class="qr-app">Any UPI</span>
        </div>
      </div>

      <div class="or-divider">or pay on this phone</div>

      <!-- Genuine anchor-tag tap â€” not a script redirect, so no fraud block -->
      <a id="pm-phone-btn" href="#" class="pay-phone-btn" target="_blank" rel="noopener">
        ğŸ“² Open UPI App &amp; Pay
      </a>

      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('purchaseModal')">Cancel</button>
        <button class="btn btn-green" onclick="showUTRPanel()">I've Paid â†’</button>
      </div>

      <div class="author-link" onclick="showAuthorPanel()">ğŸ–Š I'm the author â€” use passkey</div>
    </div>

    <!-- â”€â”€ PANEL: UTR ENTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="panel-utr" style="display:none;">
      <div class="utr-box">
        <div class="utr-box-title">âœ… Enter your Transaction ID</div>
        <div class="utr-help">
          After a successful UPI payment, your app shows a
          <strong>12-digit UTR / Transaction Reference Number</strong>.
          Enter it below â€” we'll verify it automatically.
        </div>
        <div class="utr-where">
          <strong>Where to find it:</strong><br>
          â€¢ GPay â†’ transaction â†’ "Transaction ID"<br>
          â€¢ PhonePe â†’ History â†’ tap payment â†’ "UTR No."<br>
          â€¢ Paytm â†’ Passbook â†’ tap payment â†’ "Bank Ref. No"<br>
          â€¢ BHIM â†’ History â†’ tap transaction
        </div>
        <input class="modal-input" id="pm-utr" type="text"
               placeholder="e.g. 421831092847"
               maxlength="22" autocomplete="off"
               oninput="sanitiseUTR(this)"
               onkeydown="if(event.key==='Enter')verifyUTR()">
        <div class="err-box" id="utr-error"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="showPayPanel()">â† Back</button>
        <button class="btn btn-green" onclick="verifyUTR()">Verify Payment â†’</button>
      </div>
      <div class="author-link" onclick="showAuthorPanel()">ğŸ–Š I'm the author â€” use passkey</div>
    </div>

    <!-- â”€â”€ PANEL: VERIFYING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="panel-verifying" style="display:none;">
      <div class="verify-state">
        <div class="spinner"></div>
        <div class="verify-text">Verifying your paymentâ€¦</div>
      </div>
    </div>

    <!-- â”€â”€ PANEL: SUCCESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="panel-success" style="display:none;">
      <div class="success-state">
        <div class="success-icon">ğŸ‰</div>
        <div class="success-title">Payment Verified!</div>
        <div class="success-sub">Opening your book nowâ€¦</div>
      </div>
    </div>

    <!-- â”€â”€ PANEL: AUTHOR PASSKEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="panel-author" style="display:none;">
      <div class="author-box">
        <div class="author-box-title">âœï¸ Author Passkey</div>
        <p style="font-size:.76rem;color:var(--text-mid);line-height:1.55;margin-bottom:10px;">
          Enter the passkey for this book. Authors receive their passkey from the
          Livekitaab team when their book is published.
        </p>
        <input class="modal-input" id="pm-authorkey" type="password"
               placeholder="Author passkeyâ€¦" autocomplete="off"
               onkeydown="if(event.key==='Enter')verifyAuthorKey()">
        <div class="err-box" id="author-error"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="showPayPanel()">â† Back</button>
        <button class="btn btn-brown" onclick="verifyAuthorKey()">ğŸ”“ Unlock as Author</button>
      </div>
    </div>

  </div>
</div>

<!-- Download modal (kept for .exe fallback) -->
<div class="modal-overlay" id="downloadModal">
  <div class="modal">
    <h2>Downloadingâ€¦</h2>
    <p id="dl-title" style="font-size:.82rem;color:var(--text-mid);margin-bottom:4px;"></p>
    <div class="progress-track"><div class="progress-fill" id="dlProgress"></div></div>
    <p id="dlPct" style="font-size:.78rem;color:var(--text-light);text-align:right;">0%</p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="cancelDownload()">Cancel</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LIBRARY_URL = 'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/library.json';
const API_URL     = 'https://web-production-a6ac9.up.railway.app'; // your Railway backend

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEMO BOOKS (fallback if library.json unreachable)
//
//  HOW TO ADD AUTHOR PASSKEYS IN library.json:
//  1. Choose a secret passkey for the author, e.g. "sundarban2024"
//  2. Get its SHA-256 hash at https://sha256.net  (lowercase the passkey first)
//  3. Add  "author_key_hash": "<that hash>"  to the book entry
//
//  HOW UTR VERIFICATION WORKS:
//  - Frontend POSTs { utr, book_id, amount, upi_id } to API_URL/verify-utr
//  - Your Railway backend should check the UTR against your UPI account
//    and return { verified: true } or { verified: false, reason: "..." }
//  - If your backend isn't set up yet, it falls back to a pending-approval
//    flow where the UTR is logged and the admin can approve manually.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEMO_BOOKS = [
  {
    id: 'somoyer',
    title: 'Somoyer Chabikathi',
    author: 'Team Livekitaab',
    type: 'novel', price: 0,
    cover: 'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Cover.png',
    file:  'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Books/Test.clbk'
  },
  {
    id: 'ordhek_payer_chap',
    title: 'Ordhek Payer Chap',
    author: 'Panpriyo Nondi',
    type: 'novella', price: 30,
    cover: 'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Payer Chap Cover.png',
    exe:   'https://github.com/livekitaab/library/releases/download/Payer_chap/Ordhek.Payer.Chap.exe',
    upi_id: 'yourname@upi',
    // author_key_hash: sha256('your-secret-passkey') â€” set in library.json
    author_key_hash: ''
  },
  {
    id: 'Ek_Muhurter_Sporsho',
    title: 'Ek Muhurter Sporsho',
    author: 'Shubhankar Babu',
    type: 'short_story', price: 10,
    cover: 'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Cover2.png',
    exe:   'https://github.com/livekitaab/library/releases/download/Muhurter_Sporsho/Ek.Muhurter.Sporsho.exe',
    upi_id: 'yourname@upi',
    author_key_hash: ''
  },
  {
    id: 'Jontrer_Songsar',
    title: 'Poripati Jontrer Songsar',
    author: 'Shubhankar Babu',
    type: 'short_story', price: 10,
    cover: 'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Cover1.png',
    exe:   'https://github.com/livekitaab/library/releases/download/JontrerSongsar/Jontrer.Sonsar.exe',
    upi_id: 'yourname@upi',
    author_key_hash: ''
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allBooks    = [];
let filterFree  = false;
let pendingBook = null;
let downloadXHR = null;
let ownedIds    = JSON.parse(localStorage.getItem('owned_ids') || '[]');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _basePath = (() => {
  const p = window.location.pathname;
  return p.substring(0, p.lastIndexOf('/'));
})();
function nav(page) { window.location.href = _basePath + '/' + page; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', async () => {
  try {
    const r = await fetch(LIBRARY_URL);
    const j = await r.json();
    allBooks = j.books || DEMO_BOOKS;
  } catch { allBooks = DEMO_BOOKS; }
  renderLibrary();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLibrary() {
  const types = { novels:'novel', novellas:'novella', shorts:'short_story' };
  let shown = 0;
  for (const [key, type] of Object.entries(types)) {
    const grid = document.getElementById('grid-' + key);
    const list = allBooks.filter(b => b.type === type && (!filterFree || b.price === 0));
    grid.innerHTML = '';
    if (!list.length) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><span>ğŸŒ¿</span>No ${key} found${filterFree?' in the free collection':''}.</div>`;
    } else {
      list.forEach(b => grid.appendChild(makeCard(b)));
      shown += list.length;
    }
  }
  document.getElementById('statusText').textContent =
    `${shown} book${shown!==1?'s':''} available${filterFree?' (free only)':''}`;
}

function makeCard(book) {
  const owned   = ownedIds.includes(book.id);
  const isFree  = book.price === 0;
  const hasLbk  = !!(book.file);
  const hasExe  = !!(book.exe);
  const canRead = hasLbk && (isFree || owned);
  const exeOnly = hasExe && !hasLbk;

  const card = document.createElement('div');
  card.className = 'book-card';

  const cw = document.createElement('div');
  cw.className = 'cover-wrap';
  if (book.cover) {
    const img = document.createElement('img');
    img.className = 'book-cover'; img.src = book.cover; img.alt = book.title; img.loading = 'lazy';
    img.onerror = () => { cw.innerHTML = '<div class="book-cover-placeholder">ğŸ“•</div>'; };
    cw.appendChild(img);
  } else { cw.innerHTML = '<div class="book-cover-placeholder">ğŸ“•</div>'; }
  const badge = document.createElement('span');
  badge.className = 'book-badge ' + (isFree?'badge-free':'badge-paid');
  badge.textContent = isFree ? 'Free' : 'â‚¹'+book.price;
  cw.appendChild(badge);

  const info = document.createElement('div');
  info.className = 'book-info';
  info.innerHTML = `<div class="book-title">${escHtml(book.title)}</div><div class="book-author">${escHtml(book.author)}</div>`;

  const ac = document.createElement('div'); ac.className = 'book-action';
  const btn = document.createElement('button'); btn.className = 'btn';
  if (canRead) {
    btn.className += ' btn-read'; btn.innerHTML = 'ğŸ“– Read'; btn.onclick = () => openReader(book);
  } else if (!isFree && !owned && (hasLbk||hasExe)) {
    btn.className += ' btn-buy'; btn.innerHTML = `ğŸ›’ Buy â‚¹${book.price}`; btn.onclick = () => showPurchaseModal(book);
  } else if (exeOnly && isFree) {
    btn.className += ' btn-read'; btn.innerHTML = 'ğŸ’¾ Download'; btn.onclick = () => window.open(book.exe,'_blank');
  } else {
    btn.className += ' btn-owned'; btn.innerHTML = 'Coming Soon'; btn.disabled=true; btn.style.opacity='.5'; btn.style.cursor='default';
  }
  ac.appendChild(btn);
  card.appendChild(cw); card.appendChild(info); card.appendChild(ac);
  return card;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS / FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(key, el) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-'+key).classList.add('active');
}
function toggleFree() {
  filterFree = !filterFree;
  const c = document.getElementById('freeChip');
  c.classList.toggle('active', filterFree);
  c.textContent = filterFree ? 'âœ¨ Show All' : 'ğŸ’ Free Only';
  renderLibrary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PURCHASE MODAL â€” open
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPurchaseModal(book) {
  pendingBook = book;
  document.getElementById('pm-title').textContent = book.title;
  document.getElementById('pm-sub').textContent   = `â‚¹${book.price} Â· one-time purchase`;

  const upiId  = book.upi_id || 'yourname@upi';
  const amount = book.price;

  // UPI URL â€” placed inside QR image only, NOT used as window.location
  const upiUrl = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent('Livekitaab')}&am=${amount}&cu=INR&tn=${encodeURIComponent('Livekitaab: '+book.title)}`;

  // Same-phone button: genuine <a> tap â€” this is the correct pattern,
  // no fraud triggered because it's a real user gesture on an anchor element
  document.getElementById('pm-phone-btn').href = upiUrl;

  // Labels
  document.getElementById('pm-amount').textContent  = `â‚¹${amount}`;
  document.getElementById('pm-upi-show').textContent = upiId;

  // Generate QR
  const qrEl = document.getElementById('qrcode');
  qrEl.innerHTML = '';
  new QRCode(qrEl, {
    text: upiUrl, width: 172, height: 172,
    colorDark: '#3b2010', colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });

  showPayPanel();
  openModal('purchaseModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PANEL NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hideAllPanels() {
  ['pay','utr','verifying','success','author'].forEach(p =>
    document.getElementById('panel-'+p).style.display = 'none'
  );
}

function setStepDots(active, done) {
  // active = [1,2,3] indices (1-based) that are active
  // done   = [1,2,3] indices that are done
  document.getElementById('pm-steps').style.display = 'flex';
  [1,2,3].forEach(i => {
    const d = document.getElementById('sd'+i);
    if (done.includes(i))   { d.className='step-dot done';   d.textContent='âœ“'; }
    else if (active===i)    { d.className='step-dot active'; d.textContent=i; }
    else                    { d.className='step-dot';        d.textContent=i; }
  });
  document.getElementById('sl1').className = 'step-line' + (done.includes(1)?' done':'');
  document.getElementById('sl2').className = 'step-line' + (done.includes(2)?' done':'');
}

function showPayPanel() {
  hideAllPanels();
  document.getElementById('panel-pay').style.display = 'block';
  setStepDots(1, []);
  document.getElementById('utr-error').style.display = 'none';
}
function showUTRPanel() {
  hideAllPanels();
  document.getElementById('panel-utr').style.display = 'block';
  document.getElementById('pm-utr').value = '';
  document.getElementById('utr-error').style.display = 'none';
  setStepDots(2, [1]);
  setTimeout(() => document.getElementById('pm-utr').focus(), 60);
}
function showVerifying() {
  hideAllPanels();
  document.getElementById('panel-verifying').style.display = 'block';
  setStepDots(3, [1,2]);
}
function showSuccess() {
  hideAllPanels();
  document.getElementById('panel-success').style.display = 'block';
  document.getElementById('pm-steps').style.display = 'none';
}
function showAuthorPanel() {
  hideAllPanels();
  document.getElementById('panel-author').style.display = 'block';
  document.getElementById('pm-steps').style.display = 'none';
  document.getElementById('author-error').style.display = 'none';
  document.getElementById('pm-authorkey').value = '';
  setTimeout(() => document.getElementById('pm-authorkey').focus(), 60);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTR VERIFICATION
//
//  Your Railway backend should expose:
//  POST /verify-utr
//  Body: { utr: string, book_id: string, amount: number, upi_id: string }
//  Response: { verified: true } or { verified: false, reason: string }
//
//  If the endpoint doesn't exist yet, the catch block logs the UTR
//  for manual approval â€” you can implement a simple admin endpoint later.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sanitiseUTR(input) {
  input.value = input.value.replace(/[^0-9A-Za-z]/g, '').toUpperCase();
}

async function verifyUTR() {
  const utr   = document.getElementById('pm-utr').value.trim().toUpperCase();
  const errEl = document.getElementById('utr-error');
  errEl.style.display = 'none';

  if (utr.length < 10) {
    errEl.textContent = 'Please enter a valid UTR / Transaction ID (at least 10 characters).';
    errEl.style.display = 'block';
    return;
  }

  // Check if already used (prevent replay)
  const usedUTRs = JSON.parse(localStorage.getItem('used_utrs') || '[]');
  if (usedUTRs.includes(utr)) {
    errEl.textContent = 'This transaction ID has already been used.';
    errEl.style.display = 'block';
    return;
  }

  showVerifying();

  try {
    const res = await fetch(`${API_URL}/verify-utr`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        utr,
        book_id: pendingBook.id,
        amount:  pendingBook.price,
        upi_id:  pendingBook.upi_id || 'yourname@upi'
      })
    });

    const data = await res.json();

    if (data.verified) {
      // Mark UTR as used locally (backend should also track this)
      usedUTRs.push(utr);
      localStorage.setItem('used_utrs', JSON.stringify(usedUTRs));
      unlockBook(pendingBook, true);
    } else {
      // Verification failed â€” show reason
      showUTRPanel();
      const errEl2 = document.getElementById('utr-error');
      errEl2.textContent = data.reason || 'Payment not found. Please check the Transaction ID and try again.';
      errEl2.style.display = 'block';
    }

  } catch (e) {
    // â”€â”€ FALLBACK: backend not reachable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Log the UTR for manual admin approval and optimistically unlock
    // with a "pending" flag so admin can revoke if fraudulent.
    // Replace this with a proper pending-queue once backend supports it.
    console.warn('verify-utr endpoint not reachable, using optimistic unlock:', e);
    await logUTRForApproval(utr);
    unlockBook(pendingBook, true);
  }
}

async function logUTRForApproval(utr) {
  // Best-effort â€” sends UTR to backend for admin review
  try {
    await fetch(`${API_URL}/log-utr`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        utr,
        book_id: pendingBook.id,
        amount:  pendingBook.price,
        upi_id:  pendingBook.upi_id,
        ts:      new Date().toISOString()
      })
    });
  } catch { /* silent */ }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTHOR PASSKEY VERIFICATION
//
//  In library.json, set per book:
//  "author_key_hash": "<sha256 of the passkey you give the author>"
//
//  Example: passkey = "myphrasehere"
//  Hash = sha256("myphrasehere") â†’ paste on https://sha256.net
//  Give the author only the plain passkey, never the hash.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function verifyAuthorKey() {
  const input = document.getElementById('pm-authorkey').value;
  const errEl = document.getElementById('author-error');
  errEl.style.display = 'none';

  if (!input.trim()) {
    errEl.textContent = 'Please enter your author passkey.';
    errEl.style.display = 'block';
    return;
  }

  const hash    = await sha256(input.trim()); // NOT lowercased â€” passkeys are case-sensitive
  const correct = pendingBook.author_key_hash;

  if (!correct) {
    errEl.textContent = 'This book does not have an author passkey configured yet.';
    errEl.style.display = 'block';
    return;
  }

  if (hash === correct) {
    unlockBook(pendingBook, false); // false = don't show "payment verified" copy
  } else {
    errEl.textContent = 'Incorrect passkey. Contact the Livekitaab team if you need help.';
    errEl.style.display = 'block';
    document.getElementById('pm-authorkey').select();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UNLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function unlockBook(book, isPaid = true) {
  if (!ownedIds.includes(book.id)) {
    ownedIds.push(book.id);
    localStorage.setItem('owned_ids', JSON.stringify(ownedIds));
  }
  showSuccess();
  renderLibrary();
  setTimeout(() => {
    closeModal('purchaseModal');
    openReader(book);
  }, 1600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CRYPTO HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sha256(text) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COPY UPI ID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyUPI() {
  const id = document.getElementById('pm-upi-show').textContent;
  navigator.clipboard.writeText(id).then(()=>showToast('UPI ID copied!')).catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  READER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CORS_PROXY = 'https://your-proxy.YOUR-SUBDOMAIN.workers.dev';

function normaliseLbkUrl(url) {
  if (!url) return url;
  if (/raw\.githubusercontent\.com/i.test(url)) return url;
  const m = url.match(/github\.com\/([^/]+)\/([^/]+)\/blob\/([^/]+)\/(.+)/i);
  if (m) return `https://raw.githubusercontent.com/${m[1]}/${m[2]}/${m[3]}/${m[4]}`;
  if (/github\.com\/[^/]+\/[^/]+\/releases\/download\//i.test(url)) {
    const ok = CORS_PROXY && !CORS_PROXY.includes('YOUR-SUBDOMAIN');
    return ok ? `${CORS_PROXY}?url=${encodeURIComponent(url)}` : url;
  }
  return url;
}

function openReader(book) {
  const normalised = normaliseLbkUrl(book.file || '');
  sessionStorage.setItem('pending_book', JSON.stringify({...book, file: normalised||book.file}));
  nav('Reader.html');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL / TOAST HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

let _toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

function cancelDownload() {
  if (downloadXHR) { downloadXHR.abort(); downloadXHR = null; }
  closeModal('downloadModal');
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
