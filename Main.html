<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LiveKitaab â€” Book Library</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Lora:ital,wght@0,400;0,500;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  :root {
    --brown:       #a46636;
    --brown-deep:  #7a4a22;
    --brown-dark:  #3b2010;
    --green:       #6bbf8e;
    --green-light: #a2d5a1;
    --green-dark:  #3d7a56;
    --cream:       #f6e9d7;
    --cream-dark:  #ecdcc4;
    --cream-deeper:#e0cdb0;
    --gold:        #f7e7b5;
    --gold-deep:   #d4a853;
    --text-dark:   #2a1a0e;
    --text-mid:    #5c3d1e;
    --text-light:  #8c6a45;
    --shadow-sm:   0 2px 8px rgba(58,28,8,.10);
    --shadow-md:   0 4px 20px rgba(58,28,8,.14);
    --shadow-lg:   0 8px 40px rgba(58,28,8,.18);
    --radius:      12px;
    --radius-sm:   8px;
  }

  /* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--text-dark);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ Noise texture overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  body::before {
    content: '';
    position: fixed; inset: 0; pointer-events: none; z-index: 0;
    opacity: .035;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  }

  /* â”€â”€ Page shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { position: relative; z-index: 1; display: flex; flex-direction: column; min-height: 100vh; }

  /* â”€â”€ Top nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .topnav {
    background: var(--brown-dark);
    padding: 0 24px;
    height: 52px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 2px 10px rgba(0,0,0,.35);
    position: sticky; top: 0; z-index: 100;
  }
  .topnav-brand {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem; font-weight: 700;
    color: var(--gold);
    letter-spacing: .02em;
    text-decoration: none;
  }
  .topnav-links { display: flex; gap: 6px; align-items: center; }
  .topnav-links a {
    color: var(--cream); font-size: .82rem; text-decoration: none;
    padding: 5px 12px; border-radius: 20px;
    transition: background .2s, color .2s;
    font-family: 'DM Sans', sans-serif; font-weight: 400;
  }
  .topnav-links a:hover { background: rgba(246,233,215,.12); color: var(--gold); }
  .topnav-links .btn-account {
    background: var(--green); color: var(--brown-dark);
    font-weight: 500; padding: 5px 16px;
  }
  .topnav-links .btn-account:hover { background: var(--green-light); }

  /* â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .banner {
    background: linear-gradient(120deg, var(--green) 0%, var(--green-light) 55%, var(--gold-deep) 100%);
    padding: 36px 32px 32px;
    display: flex; align-items: center; gap: 20px;
    position: relative; overflow: hidden;
  }
  .banner::after {
    content: 'ğŸ“š';
    position: absolute; right: -10px; bottom: -18px;
    font-size: 110px; opacity: .10; pointer-events: none;
    transform: rotate(-8deg);
  }
  .banner-icon { font-size: 2.6rem; flex-shrink: 0; filter: drop-shadow(0 2px 6px rgba(0,0,0,.15)); }
  .banner-text h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(1.5rem, 4vw, 2rem);
    font-weight: 900; color: var(--brown-dark);
    line-height: 1.15;
  }
  .banner-text p {
    font-family: 'Lora', serif; font-style: italic;
    color: var(--brown-deep); font-size: .9rem; margin-top: 5px;
  }

  /* â”€â”€ Filter bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .filter-bar {
    background: var(--cream-dark);
    border-bottom: 1.5px solid var(--cream-deeper);
    padding: 10px 20px;
    display: flex; align-items: center; gap: 10px;
    flex-wrap: wrap;
  }
  .filter-label {
    font-size: .78rem; font-weight: 500; color: var(--text-light);
    text-transform: uppercase; letter-spacing: .08em;
    margin-right: 4px;
  }
  .chip {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 14px; border-radius: 20px; font-size: .8rem;
    cursor: pointer; transition: all .2s;
    border: 1.5px solid var(--brown); color: var(--brown);
    background: transparent; font-family: 'DM Sans', sans-serif;
    white-space: nowrap;
  }
  .chip.active { background: var(--green); border-color: var(--green); color: var(--brown-dark); font-weight: 500; }
  .chip:hover:not(.active) { background: rgba(164,102,54,.07); }
  .filter-spacer { flex: 1; }
  #statusText { font-size: .78rem; color: var(--text-light); font-style: italic; }

  /* â”€â”€ Tab strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tab-strip {
    display: flex; background: var(--brown-dark);
    border-bottom: 2px solid rgba(164,102,54,.35);
    position: sticky; top: 52px; z-index: 90;
  }
  .tab-btn {
    flex: 1; padding: 13px 8px; text-align: center;
    font-family: 'DM Sans', sans-serif; font-size: .84rem; font-weight: 500;
    color: rgba(246,233,215,.55); cursor: pointer; border: none;
    background: transparent; transition: all .2s;
    border-bottom: 3px solid transparent; margin-bottom: -2px;
    white-space: nowrap;
  }
  .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold-deep); }
  .tab-btn:hover:not(.active) { color: var(--cream); background: rgba(246,233,215,.06); }

  /* â”€â”€ Tab panels â€” wooden shelf â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tab-panel {
    display: none;
    padding: 28px 16px 80px;
    animation: fadeIn .2s ease;
    background:
      repeating-linear-gradient(
        180deg,
        rgba(0,0,0,.0)  0px,  rgba(0,0,0,.0)  17px,
        rgba(0,0,0,.05) 17px, rgba(0,0,0,.05) 18px,
        rgba(255,255,255,.03) 18px, rgba(255,255,255,.03) 19px,
        rgba(0,0,0,.0)  19px, rgba(0,0,0,.0)  36px
      ),
      linear-gradient(172deg,
        #5c2e10 0%, #7a4422 20%, #a46636 40%,
        #8b5530 58%, #7a4422 75%, #5c2e10 100%
      );
    box-shadow: inset 0 8px 20px rgba(0,0,0,.30), inset 0 -4px 10px rgba(0,0,0,.20);
    min-height: 280px;
  }
  .tab-panel.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  /* â”€â”€ Book grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .book-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(155px, 1fr));
    gap: 18px;
  }
  .empty-state {
    text-align: center; padding: 60px 20px;
    color: var(--gold); font-family: 'Lora', serif; font-style: italic;
    font-size: 1rem; text-shadow: 0 1px 3px rgba(0,0,0,.4);
  }
  .empty-state span { display: block; font-size: 2.5rem; margin-bottom: 12px; }

  /* â”€â”€ Book card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .book-card {
    background: var(--cream); border-radius: var(--radius);
    box-shadow: 0 6px 18px rgba(0,0,0,.40), 0 2px 4px rgba(0,0,0,.22);
    overflow: hidden; cursor: pointer;
    transition: transform .22s ease, box-shadow .22s ease;
    display: flex; flex-direction: column;
  }
  .book-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 18px 36px rgba(0,0,0,.50), 0 4px 8px rgba(0,0,0,.28); }
  .book-cover {
    width: 100%; aspect-ratio: 2/3;
    object-fit: cover; display: block;
    background: linear-gradient(135deg, var(--brown) 0%, var(--brown-deep) 100%);
    position: relative;
  }
  .book-cover-placeholder {
    width: 100%; aspect-ratio: 2/3;
    background: linear-gradient(135deg, var(--brown) 0%, var(--brown-deep) 100%);
    display: flex; align-items: center; justify-content: center;
    font-size: 2.4rem; color: var(--gold); opacity: .7;
  }
  .book-badge {
    position: absolute; top: 8px; right: 8px;
    padding: 2px 8px; border-radius: 10px; font-size: .65rem; font-weight: 600;
    letter-spacing: .04em; text-transform: uppercase;
  }
  .badge-free { background: var(--green); color: var(--brown-dark); }
  .badge-paid { background: var(--gold-deep); color: var(--brown-dark); }
  .book-info { padding: 10px 10px 0; flex: 1; }
  .book-title {
    font-family: 'Playfair Display', serif;
    font-size: .88rem; font-weight: 600;
    color: var(--text-dark); line-height: 1.35;
    display: -webkit-box; -webkit-line-clamp: 2;
    -webkit-box-orient: vertical; overflow: hidden;
  }
  .book-author {
    font-family: 'Lora', serif; font-style: italic;
    font-size: .72rem; color: var(--text-light); margin-top: 3px;
  }
  .book-action { padding: 8px 10px 10px; }
  .btn {
    width: 100%; padding: 7px; border: none; border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 500;
    cursor: pointer; transition: all .18s; display: flex; align-items: center; justify-content: center; gap: 5px;
  }
  .btn-read { background: var(--green); color: var(--brown-dark); }
  .btn-read:hover { background: var(--green-dark); color: white; }
  .btn-buy { background: var(--brown); color: var(--cream); }
  .btn-buy:hover { background: var(--brown-deep); }
  .btn-owned { background: var(--cream-dark); color: var(--text-mid); border: 1.5px solid var(--cream-deeper); }

  /* â”€â”€ Modal backdrop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(42,26,14,.55); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    padding: 20px; opacity: 0; pointer-events: none;
    transition: opacity .2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--cream); border-radius: var(--radius);
    box-shadow: var(--shadow-lg); padding: 28px 24px;
    width: 100%; max-width: 360px;
    transform: translateY(16px); transition: transform .2s;
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal h2 {
    font-family: 'Playfair Display', serif; font-size: 1.15rem;
    color: var(--text-dark); margin-bottom: 8px;
  }
  .modal p { font-size: .84rem; color: var(--text-mid); margin-bottom: 16px; line-height: 1.55; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
  .modal-actions .btn { width: auto; padding: 8px 20px; font-size: .82rem; }
  .btn-ghost { background: transparent; color: var(--text-light); border: 1.5px solid var(--cream-deeper); }
  .btn-ghost:hover { background: var(--cream-dark); color: var(--text-mid); border-color: var(--cream-deeper); }
  .btn-primary { background: var(--brown); color: var(--cream); }
  .btn-primary:hover { background: var(--brown-deep); }
  .btn-green { background: var(--green); color: var(--brown-dark); }
  .btn-green:hover { background: var(--green-dark); color: white; }
  .modal-input {
    width: 100%; padding: 9px 12px; border-radius: var(--radius-sm);
    border: 1.5px solid var(--cream-deeper); background: white;
    font-family: 'DM Sans', sans-serif; font-size: .85rem;
    color: var(--text-dark); outline: none; margin-bottom: 12px;
    transition: border-color .18s;
  }
  .modal-input:focus { border-color: var(--green); }
  .modal-input::placeholder { color: var(--text-light); }
  .modal-divider { height: 1px; background: var(--cream-deeper); margin: 14px 0; }
  .modal-small { font-size: .75rem; color: var(--text-light); font-style: italic; }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--brown-dark); color: var(--cream);
    padding: 10px 22px; border-radius: 30px;
    font-size: .82rem; box-shadow: var(--shadow-md);
    transition: transform .3s ease; z-index: 999; white-space: nowrap;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }

  /* â”€â”€ Loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loader-dots { display: inline-flex; gap: 5px; }
  .loader-dots span {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--brown); opacity: .3;
    animation: pulse 1.2s infinite;
  }
  .loader-dots span:nth-child(2) { animation-delay: .2s; }
  .loader-dots span:nth-child(3) { animation-delay: .4s; }
  @keyframes pulse { 0%,80%,100%{ opacity:.3; transform:scale(1); } 40%{ opacity:1; transform:scale(1.3); } }

  /* â”€â”€ Progress bar in modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-track {
    width: 100%; height: 8px; background: var(--cream-deeper);
    border-radius: 4px; overflow: hidden; margin: 12px 0;
  }
  .progress-fill {
    height: 100%; background: linear-gradient(90deg, var(--green), var(--green-dark));
    border-radius: 4px; width: 0%; transition: width .3s ease;
  }
</style>
</head>
<body>
<div id="app">

  <!-- Top nav -->
  <nav class="topnav">
    <a class="topnav-brand" href="Main.html"><span style="color:#ffffff;font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;">Live</span><span style="color:#f7e7b5;font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;">Kitaab</span></a>
    <div class="topnav-links">
      <a href="Main.html">Library</a>
      <a href="Reader.html">Reader</a>
      <a href="Account.html" class="btn-account">My Account</a>
    </div>
  </nav>

  <!-- Banner -->
  <div class="banner">
    <div class="banner-icon">ğŸ“–</div>
    <div class="banner-text">
      <h1>Discover Your Next Story</h1>
      <p>Curated fiction â€” novels, novellas &amp; short stories</p>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar">
    <span class="filter-label">Filter</span>
    <button class="chip" id="freeChip" onclick="toggleFree()">ğŸ’ Free Only</button>
    <div class="filter-spacer"></div>
    <span id="statusText">Loading libraryâ€¦</span>
  </div>

  <!-- Tab strip -->
  <div class="tab-strip">
    <button class="tab-btn active" onclick="switchTab('novels',this)">ğŸ“– Novels</button>
    <button class="tab-btn" onclick="switchTab('novellas',this)">ğŸ“˜ Novellas</button>
    <button class="tab-btn" onclick="switchTab('shorts',this)">ğŸ“ Short Stories</button>
  </div>

  <!-- Tab panels -->
  <div id="panel-novels"   class="tab-panel active"><div class="book-grid" id="grid-novels"></div></div>
  <div id="panel-novellas" class="tab-panel"><div class="book-grid" id="grid-novellas"></div></div>
  <div id="panel-shorts"   class="tab-panel"><div class="book-grid" id="grid-shorts"></div></div>

</div><!-- #app -->

<!-- Purchase modal -->
<div class="modal-overlay" id="purchaseModal">
  <div class="modal">
    <h2 id="pm-title">Purchase Book</h2>
    <p id="pm-desc" style="margin-bottom:14px;"></p>

    <!-- Step 1: Pay via UPI -->
    <div id="pm-step1">
      <p style="font-size:.75rem;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">Step 1 â€” Pay</p>
      <button class="btn btn-primary" id="pm-upi" style="width:100%;margin-bottom:6px;">
        <span id="pm-upi-label">ğŸ“² Pay via UPI</span>
      </button>
      <p style="font-size:.72rem;color:var(--text-light);text-align:center;margin-bottom:12px;" id="pm-upi-hint"></p>
    </div>

    <div class="modal-divider"></div>

    <!-- Step 2: Enter book password -->
    <div id="pm-step2">
      <p style="font-size:.75rem;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">Step 2 â€” Enter Book Password</p>
      <p style="font-size:.78rem;color:var(--text-mid);margin-bottom:10px;">After payment, you will receive a password. Enter it below to unlock the book.</p>
      <input class="modal-input" id="pm-password" type="text" placeholder="Enter book passwordâ€¦" autocomplete="off">
      <div id="pm-error" style="font-size:.78rem;color:#c0392b;margin-bottom:8px;display:none;padding:6px 10px;background:#fdf0ee;border-radius:6px;"></div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('purchaseModal')">Cancel</button>
      <button class="btn btn-green" onclick="verifyPassword()">ğŸ”“ Unlock</button>
    </div>
  </div>
</div>

<!-- Download progress modal -->
<div class="modal-overlay" id="downloadModal">
  <div class="modal">
    <h2>Downloadingâ€¦</h2>
    <p id="dl-title" style="font-size:.82rem;color:var(--text-mid);margin-bottom:4px;"></p>
    <div class="progress-track"><div class="progress-fill" id="dlProgress"></div></div>
    <p id="dlPct" style="font-size:.78rem;color:var(--text-light);text-align:right;">0%</p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="cancelDownload()">Cancel</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LIBRARY_URL = 'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/library.json';
const API_URL     = 'https://web-production-a6ac9.up.railway.app';
// â”€â”€ Fallback books if library.json can't be fetched â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEMO_BOOKS = [
  { id:'somoyer', title:'Somoyer Chabikathi', author:'Team Livekitaab', type:'novel', price:0,
    cover:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Cover.png',
    file:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Books/Test.clbk' },
  { id:'ordhek_payer_chap', title:'Ordhek Payer Chap', author:'Panpriyo Nondi', type:'novella', price:30,
    cover:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Payer Chap Cover.png',
    exe:'https://github.com/livekitaab/library/releases/download/Payer_chap/Ordhek.Payer.Chap.exe',
    // upi_id: your UPI ID e.g. 'yourname@upi'  â€” set this in library.json
    // password_hash: SHA-256 of the book password â€” generate at sha256.net
    upi_id:'yourname@upi',
    password_hash:'6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b' },
  { id:'Ek_Muhurter_Sporsho', title:'Ek Muhurter Sporsho', author:'Shubhankar Babu', type:'short_story', price:10,
    cover:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Cover2.png',
    exe:'https://github.com/livekitaab/library/releases/download/Muhurter_Sporsho/Ek.Muhurter.Sporsho.exe',
    upi_id:'yourname@upi',
    password_hash:'6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b' },
  { id:'Jontrer_Songsar', title:'Poripati Jontrer Songsar', author:'Shubhankar Babu', type:'short_story', price:10,
    cover:'https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/Covers/Cover1.png',
    exe:'https://github.com/livekitaab/library/releases/download/JontrerSongsar/Jontrer.Sonsar.exe',
    upi_id:'yourname@upi',
    password_hash:'6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b' },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allBooks      = [];
let filterFree    = false;
let pendingBook   = null;
let downloadXHR   = null;
// Load purchased IDs from localStorage (backend would validate these)
let ownedIds      = JSON.parse(localStorage.getItem('owned_ids') || '[]');
let currentUser   = JSON.parse(localStorage.getItem('current_user') || 'null');

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ Navigation helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Auto-detects the base path so navigation works whether the site is at
// https://user.github.io/ (root) or https://user.github.io/reponame/ (subfolder).
const _basePath = (() => {
  const p = window.location.pathname;
  // Find the directory containing the current .html file
  const dir = p.substring(0, p.lastIndexOf('/'));
  return dir; // e.g. '' or '/the-shelf'
})();
function nav(page) {
  window.location.href = _basePath + '/' + page;
}
function navHref(page) {
  return _basePath + '/' + page;
}
// Rewrite all nav links once DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('a[data-page]').forEach(a => {
    a.href = navHref(a.dataset.page);
  });
});

window.addEventListener('DOMContentLoaded', () => {
  loadLibrary();
});

async function loadLibrary() {
  try {
    const r = await fetch(LIBRARY_URL);
    const j = await r.json();
    allBooks = j.books || DEMO_BOOKS;
  } catch {
    allBooks = DEMO_BOOKS; // fallback to demo
  }
  renderLibrary();
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLibrary() {
  const types = { novels: 'novel', novellas: 'novella', shorts: 'short_story' };
  let shown = 0;
  for (const [key, type] of Object.entries(types)) {
    const grid = document.getElementById('grid-' + key);
    const filtered = allBooks.filter(b => b.type === type && (!filterFree || b.price === 0));
    grid.innerHTML = '';
    if (filtered.length === 0) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
        <span>ğŸŒ¿</span>No ${key} found${filterFree ? ' in the free collection' : ''}.
      </div>`;
    } else {
      filtered.forEach(b => grid.appendChild(makeCard(b)));
      shown += filtered.length;
    }
  }
  const free = filterFree ? ' (free only)' : '';
  document.getElementById('statusText').textContent = `${shown} book${shown!==1?'s':''} available${free}`;
}

function makeCard(book) {
  const owned    = ownedIds.includes(book.id);
  const isFree   = book.price === 0;
  const hasLbk   = !!(book.file);          // has a readable .lbk/.clbk
  const hasExe   = !!(book.exe);           // legacy desktop-only .exe
  const canRead  = hasLbk && (isFree || owned);
  const canBuyWeb = hasLbk && !isFree && !owned; // paid web book
  const exeOnly  = hasExe && !hasLbk;     // old exe, no web reader

  const card = document.createElement('div');
  card.className = 'book-card';

  // Cover
  const coverWrap = document.createElement('div');
  coverWrap.style.position = 'relative';
  if (book.cover) {
    const img = document.createElement('img');
    img.className = 'book-cover';
    img.src = book.cover;
    img.alt = book.title;
    img.loading = 'lazy';
    img.onerror = () => { coverWrap.innerHTML = coverPlaceholder(); };
    coverWrap.appendChild(img);
  } else {
    coverWrap.innerHTML = coverPlaceholder();
  }
  // Badge
  const badge = document.createElement('span');
  badge.className = 'book-badge ' + (isFree ? 'badge-free' : 'badge-paid');
  badge.textContent = isFree ? 'Free' : 'â‚¹' + book.price;
  coverWrap.appendChild(badge);

  // Info
  const info = document.createElement('div');
  info.className = 'book-info';
  info.innerHTML = `<div class="book-title">${escHtml(book.title)}</div>
    <div class="book-author">${escHtml(book.author)}</div>`;

  // Action
  const action = document.createElement('div');
  action.className = 'book-action';
  const btn = document.createElement('button');
  btn.className = 'btn';
  if (canRead) {
    btn.className += ' btn-read';
    btn.innerHTML = 'ğŸ“– Read';
    btn.onclick = () => openReader(book);
  } else if (owned && hasLbk) {
    btn.className += ' btn-owned';
    btn.innerHTML = 'âœ“ Read';
    btn.onclick = () => openReader(book);
  } else if (canBuyWeb) {
    btn.className += ' btn-buy';
    btn.innerHTML = `ğŸ›’ Buy â‚¹${book.price}`;
    btn.onclick = () => showPurchaseModal(book);
  } else if (exeOnly && isFree) {
    btn.className += ' btn-read';
    btn.innerHTML = 'ğŸ’¾ Download';
    btn.onclick = () => window.open(book.exe, '_blank');
  } else if (exeOnly && !isFree) {
    btn.className += ' btn-buy';
    btn.innerHTML = `ğŸ›’ Buy â‚¹${book.price}`;
    btn.onclick = () => showPurchaseModal(book);
  } else {
    btn.className += ' btn-owned';
    btn.innerHTML = 'Coming Soon';
    btn.disabled = true;
    btn.style.opacity = '0.5';
    btn.style.cursor = 'default';
  }
  action.appendChild(btn);

  card.appendChild(coverWrap);
  card.appendChild(info);
  card.appendChild(action);
  return card;
}

function coverPlaceholder() {
  return `<div class="book-cover-placeholder">ğŸ“•</div>`;
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(key, el) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-' + key).classList.add('active');
}

// â”€â”€ Free filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFree() {
  filterFree = !filterFree;
  const chip = document.getElementById('freeChip');
  chip.classList.toggle('active', filterFree);
  chip.textContent = filterFree ? 'âœ¨ Show All' : 'ğŸ’ Free Only';
  renderLibrary();
}

// â”€â”€ Purchase flow â€” UPI + book password â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPurchaseModal(book) {
  pendingBook = book;
  document.getElementById('pm-title').textContent = book.title;
  document.getElementById('pm-desc').textContent =
    `â‚¹${book.price} Â· one-time purchase`;

  // Build UPI deep link
  // Works on mobile: opens GPay / PhonePe / Paytm directly
  // On desktop: shows the UPI ID to pay manually
  const upiId   = book.upi_id || 'yourname@upi';
  const amount  = book.price;
  const note    = encodeURIComponent('Book: ' + book.title);
  const name    = encodeURIComponent('Livekitaab');
  const upiLink = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${name}&am=${amount}&cu=INR&tn=${note}`;

  document.getElementById('pm-upi-label').textContent = `ğŸ“² Pay â‚¹${amount} via UPI`;
  document.getElementById('pm-upi-hint').textContent  = `UPI ID: ${upiId}`;
  document.getElementById('pm-upi').onclick = () => {
    window.location.href = upiLink;   // opens UPI app on mobile
    showToast('Opening UPI appâ€¦ come back here after paying.');
  };

  document.getElementById('pm-password').value = '';
  document.getElementById('pm-error').style.display = 'none';
  openModal('purchaseModal');
}

// SHA-256 using the browser's native SubtleCrypto â€” no library needed
async function sha256(text) {
  const buf  = await crypto.subtle.digest('SHA-256',
    new TextEncoder().encode(text.trim().toLowerCase()));
  return Array.from(new Uint8Array(buf))
    .map(b => b.toString(16).padStart(2, '0')).join('');
}

async function verifyPassword() {
  const input = document.getElementById('pm-password').value.trim();
  const errEl = document.getElementById('pm-error');
  errEl.style.display = 'none';

  if (!input) {
    errEl.textContent = 'Please enter the book password.';
    errEl.style.display = 'block';
    return;
  }

  const hash    = await sha256(input);
  const correct = pendingBook.password_hash;

  if (!correct) {
    // No hash set â€” dev/fallback: unlock directly
    unlockBook(pendingBook);
    return;
  }

  if (hash === correct) {
    unlockBook(pendingBook);
  } else {
    errEl.textContent = 'Incorrect password. Please check and try again.';
    errEl.style.display = 'block';
    document.getElementById('pm-password').focus();
  }
}

function unlockBook(book) {
  if (!ownedIds.includes(book.id)) {
    ownedIds.push(book.id);
    localStorage.setItem('owned_ids', JSON.stringify(ownedIds));
  }
  closeModal('purchaseModal');
  showToast('âœ“ Unlocked! Opening bookâ€¦');
  renderLibrary();
  setTimeout(() => openReader(book), 900);
}

// â”€â”€ CORS Proxy (must match Reader.html) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CORS_PROXY = 'https://your-proxy.YOUR-SUBDOMAIN.workers.dev';

// â”€â”€ URL normaliser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normaliseLbkUrl(url) {
  if (!url) return url;
  if (/raw\.githubusercontent\.com/i.test(url)) return url;
  const blobMatch = url.match(/github\.com\/([^/]+)\/([^/]+)\/blob\/([^/]+)\/(.+)/i);
  if (blobMatch) {
    const [,user,repo,branch,path] = blobMatch;
    return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
  }
  if (/github\.com\/[^/]+\/[^/]+\/releases\/download\//i.test(url)) {
    const proxyReady = CORS_PROXY && !CORS_PROXY.includes('YOUR-SUBDOMAIN');
    return proxyReady ? `${CORS_PROXY}?url=${encodeURIComponent(url)}` : url;
  }
  return url;
}

// â”€â”€ Open reader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openReader(book) {
  // Normalise file URL before handing to reader
  const normalised = normaliseLbkUrl(book.file || '');
  const bookToPass = { ...book, file: normalised || book.file }; // keep original if normalised is null
  sessionStorage.setItem('pending_book', JSON.stringify(bookToPass));
  nav('Reader.html');
}

// â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// â”€â”€ Cancel download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cancelDownload() {
  if (downloadXHR) { downloadXHR.abort(); downloadXHR = null; }
  closeModal('downloadModal');
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
