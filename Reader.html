<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LiveKitaab â€” Reader</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --brown:       #a46636;
    --brown-deep:  #7a4a22;
    --brown-dark:  #3b2010;
    --green:       #6bbf8e;
    --green-light: #a2d5a1;
    --cream:       #f6e9d7;
    --cream-dark:  #ecdcc4;
    --gold:        #f7e7b5;
    --gold-deep:   #d4a853;
    --text-dark:   #2a1a0e;
    --text-mid:    #5c3d1e;
    --text-light:  #8c6a45;
    --shadow-sm:   0 2px 8px rgba(58,28,8,.10);
    --shadow-md:   0 4px 20px rgba(58,28,8,.14);
    --radius:      12px;
    --radius-sm:   8px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  html { overflow: hidden; } /* prevent any horizontal bleed */

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--brown-dark);
    color: var(--cream);
    min-height: 100vh;
    min-height: 100dvh; /* accounts for mobile browser chrome shifting */
    overflow-x: hidden;
    overflow-y: hidden; /* scroll happens inside #readerScroll, not body */
    width: 100%;
    max-width: 100vw;
  }
  body::before {
    content: '';
    position: fixed; inset: 0; pointer-events: none; z-index: 0;
    opacity: .025;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  }

  /* â”€â”€ Reader chrome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #readerApp {
    position: relative; z-index: 1;
    display: flex; flex-direction: column;
    height: 100vh;
    height: 100dvh; /* mobile: excludes browser address bar from height */
    width: 100%;
    max-width: 100vw;
    overflow: hidden;
  }

  /* Top bar */
  .reader-topbar {
    background: var(--brown-dark);
    border-bottom: 1px solid rgba(246,233,215,.08);
    padding: 0 12px;
    height: 52px;
    display: flex; align-items: center; gap: 8px;
    flex-shrink: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,.3);
    position: relative; z-index: 50;
    width: 100%; max-width: 100vw;
    overflow: hidden;
  }
  .back-btn {
    background: rgba(246,233,215,.08); border: none;
    color: var(--cream); padding: 7px 10px; border-radius: 20px;
    cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: .8rem;
    display: flex; align-items: center; gap: 5px;
    transition: background .18s; white-space: nowrap; flex-shrink: 0;
  }
  .back-btn:hover { background: rgba(246,233,215,.15); }
  /* On very small screens, hide the label and just show â† */
  @media (max-width: 360px) {
    .back-btn .back-label { display: none; }
    .back-btn { padding: 7px 10px; }
  }
  #readerBookTitle {
    font-family: 'Playfair Display', serif;
    font-size: .88rem; font-weight: 600;
    color: var(--gold); flex: 1; overflow: hidden;
    text-overflow: ellipsis; white-space: nowrap;
    min-width: 0; /* required for ellipsis to work inside flex */
  }
  .reader-controls { display: flex; gap: 5px; flex-shrink: 0; }
  .ctrl-btn {
    background: rgba(246,233,215,.08); border: none;
    color: var(--cream); width: 34px; height: 34px; border-radius: 50%;
    cursor: pointer; font-size: .9rem;
    display: flex; align-items: center; justify-content: center;
    transition: background .18s;
    /* Ensure tap targets are big enough on mobile */
    min-width: 34px; min-height: 34px;
    -webkit-tap-highlight-color: transparent;
  }
  .ctrl-btn:hover { background: rgba(246,233,215,.16); }
  .ctrl-btn.active { background: var(--green); color: var(--brown-dark); }

  /* Chapter drawer */
  .chapter-drawer {
    position: fixed; top: 52px; right: 0;
    width: min(280px, 88vw);
    background: var(--brown-dark);
    border-left: 1px solid rgba(246,233,215,.10);
    border-bottom: 1px solid rgba(246,233,215,.10);
    border-radius: 0 0 0 var(--radius);
    box-shadow: -4px 4px 20px rgba(0,0,0,.45);
    z-index: 200; padding: 8px 0;
    max-height: calc(100dvh - 52px); overflow-y: auto;
    transform: translateX(110%); transition: transform .25s ease;
    /* Prevent drawer from ever exceeding screen width */
    max-width: 100vw;
  }
  .chapter-drawer.open { transform: translateX(0); }
  .drawer-title {
    font-family: 'Playfair Display', serif;
    font-size: .8rem; font-weight: 600;
    color: var(--text-light); text-transform: uppercase;
    letter-spacing: .08em; padding: 8px 18px 6px;
  }
  .chapter-item {
    padding: 9px 18px; font-size: .84rem; cursor: pointer;
    color: var(--cream); transition: background .15s;
    border-left: 3px solid transparent;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .chapter-item:hover { background: rgba(246,233,215,.07); }
  .chapter-item.active { border-left-color: var(--green); color: var(--gold); font-weight: 500; }

  /* Font size panel */
  .font-panel {
    position: fixed; top: 52px; right: 0;
    background: var(--brown-dark); border: 1px solid rgba(246,233,215,.10);
    border-top: none; border-radius: 0 0 var(--radius) var(--radius);
    padding: 14px 20px; z-index: 200;
    box-shadow: 0 8px 24px rgba(0,0,0,.3);
    display: none;
  }
  .font-panel.open { display: flex; align-items: center; gap: 14px; }
  @media (max-width: 400px) {
    /* On very small screens expand the font panel full width so it's easy to tap */
    .font-panel { left: 0; right: 0; border-radius: 0 0 var(--radius) var(--radius); justify-content: center; }
  }
  .fp-label { font-size: .78rem; color: var(--text-light); }
  .fp-btn {
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(246,233,215,.08); border: none;
    color: var(--cream); font-size: 1.1rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background .15s;
    -webkit-tap-highlight-color: transparent;
    /* Minimum 44px touch target recommended by Apple/Google */
    min-width: 44px; min-height: 44px;
  }
  .fp-btn:hover { background: rgba(246,233,215,.18); }
  #fpSize { min-width: 28px; text-align: center; font-size: .85rem; color: var(--gold); }

  /* Scroll area */
  #readerScroll {
    flex: 1; overflow-y: auto; overflow-x: hidden;
    padding: 24px 0 80px; /* 80px bottom pad = room for music bar */
    scroll-behavior: smooth;
    /* iOS momentum scrolling */
    -webkit-overflow-scrolling: touch;
    /* Prevent scroll from leaking to body on iOS */
    overscroll-behavior: contain;
    width: 100%;
  }
  #readerScroll::-webkit-scrollbar { width: 4px; }
  #readerScroll::-webkit-scrollbar-track { background: transparent; }
  #readerScroll::-webkit-scrollbar-thumb { background: rgba(246,233,215,.15); border-radius: 3px; }

  /* â”€â”€ Chapter card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chapter-card {
    max-width: 680px; margin: 0 auto 24px;
    background: var(--cream); border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    padding: 28px 32px;
    position: relative; overflow: hidden;
    animation: cardIn .35s ease;
    /* Prevent card from ever exceeding viewport width */
    width: calc(100% - 24px);
    box-sizing: border-box;
  }
  @media (max-width: 600px) {
    .chapter-card { padding: 20px 16px; width: calc(100% - 16px); margin: 0 8px 16px; border-radius: var(--radius-sm); }
  }
  @media (max-width: 380px) {
    .chapter-card { padding: 16px 14px; width: calc(100% - 12px); margin: 0 6px 14px; }
  }
  @keyframes cardIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
  .chapter-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
    background: linear-gradient(90deg, var(--green), var(--gold-deep));
  }
  .chapter-heading {
    font-family: 'Playfair Display', serif;
    font-size: clamp(1rem, 4vw, 1.25rem); font-weight: 700;
    color: var(--brown-deep); margin-bottom: 18px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--cream-dark);
  }

  /* â”€â”€ Text spans â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .text-paragraph {
    font-family: 'Lora', serif;
    line-height: 1.85;
    margin-bottom: 0;
    color: var(--text-dark);
    word-break: break-word;     /* prevent long words / URLs overflowing card */
    overflow-wrap: break-word;
  }
  .text-paragraph + .text-paragraph { margin-top: var(--para-gap, 16px); }
  .span-bold   { font-weight: 700; }
  .span-italic { font-style: italic; }
  .span-underline { text-decoration: underline; }

  /* â”€â”€ GIF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gif-wrap { text-align: center; margin-bottom: var(--gif-gap, 12px); }
  .gif-wrap img {
    max-width: 100%; width: auto; height: auto;
    border-radius: var(--radius-sm); display: inline-block;
    /* Never wider than the card on any screen */
    object-fit: contain;
  }

  /* â”€â”€ Divider between chapters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chapter-divider {
    max-width: 680px; margin: 0 auto 20px;
    width: calc(100% - 24px);
    height: 1px; background: rgba(246,233,215,.08);
  }
  @media (max-width: 600px) { .chapter-divider { width: calc(100% - 16px); margin: 0 8px 14px; } }

  /* â”€â”€ Music bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #musicBar {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 80;
    background: rgba(42,26,14,.95); backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid rgba(246,233,215,.10);
    /* Safe area inset for iPhone notch/home bar */
    padding: 8px 16px calc(8px + env(safe-area-inset-bottom, 0px)) 16px;
    display: none;
    align-items: center; gap: 10px;
    width: 100%; box-sizing: border-box;
  }
  #musicBar.visible { display: flex; }
  .music-icon { font-size: 1rem; color: var(--gold); flex-shrink: 0; }
  .music-label {
    font-size: .76rem; color: var(--cream); flex: 1;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    min-width: 0; /* flex ellipsis fix */
  }
  .music-btn {
    background: rgba(246,233,215,.12); border: none;
    color: var(--cream); width: 44px; height: 44px; border-radius: 50%;
    cursor: pointer; font-size: 1rem; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent;
    transition: background .15s;
  }
  .music-btn:hover { background: rgba(246,233,215,.22); }

  /* â”€â”€ Loading / Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #loadingState {
    max-width: 460px; width: 100%;
    margin: 60px auto; text-align: center;
    color: var(--text-light); padding: 20px 24px;
    box-sizing: border-box;
  }
  #loadingState .icon { font-size: 2.8rem; margin-bottom: 14px; }
  #loadingState h2 { font-family: 'Playfair Display', serif; color: var(--gold); margin-bottom: 8px; font-size: 1.2rem; }
  #loadingState p { font-size: .84rem; font-family: 'Lora', serif; font-style: italic; line-height: 1.65; word-break: break-word; }
  .open-file-btn {
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 20px; padding: 10px 24px; border-radius: 30px;
    background: var(--green); color: var(--brown-dark);
    font-family: 'DM Sans', sans-serif; font-size: .88rem; font-weight: 500;
    cursor: pointer; border: none; transition: background .18s;
  }
  .open-file-btn:hover { background: var(--green-light); }
  #fileInput { display: none; }

  /* â”€â”€ Loader dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loader { display: flex; justify-content: center; gap: 7px; padding: 20px; }
  .loader span { width: 8px; height: 8px; border-radius: 50%; background: var(--green); opacity: .3; animation: ld 1.2s infinite; }
  .loader span:nth-child(2) { animation-delay: .2s; }
  .loader span:nth-child(3) { animation-delay: .4s; }
  @keyframes ld { 0%,80%,100%{ opacity:.3; transform:scale(1); } 40%{ opacity:1; transform:scale(1.4); } }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #toast {
    position: fixed; bottom: calc(64px + env(safe-area-inset-bottom, 0px));
    left: 50%; transform: translateX(-50%) translateY(60px);
    background: var(--brown-dark); color: var(--cream); border: 1px solid rgba(246,233,215,.12);
    padding: 9px 20px; border-radius: 30px; font-size: .8rem;
    box-shadow: var(--shadow-md); transition: transform .3s ease; z-index: 999;
    white-space: nowrap; max-width: calc(100vw - 32px);
    overflow: hidden; text-overflow: ellipsis;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div id="readerApp">

  <!-- Top bar -->
  <div class="reader-topbar">
    <button class="back-btn" onclick="goBack()">â† <span class="back-label">Library</span></button>
    <span id="readerBookTitle">LiveKitaab â€” Reader</span>
    <div class="reader-controls">
      <button class="ctrl-btn" id="btnFont"    onclick="toggleFontPanel()" title="Font size">Aa</button>
      <button class="ctrl-btn" id="btnChapters" onclick="toggleDrawer()" title="Chapters">â˜°</button>
    </div>
  </div>

  <!-- Font size panel -->
  <div class="font-panel" id="fontPanel">
    <span class="fp-label">Font</span>
    <button class="fp-btn" onclick="adjustFont(-1)">âˆ’</button>
    <span id="fpSize">16</span>
    <button class="fp-btn" onclick="adjustFont(+1)">+</button>
  </div>

  <!-- Chapter drawer -->
  <div class="chapter-drawer" id="chapterDrawer">
    <div class="drawer-title">Chapters</div>
    <div id="chapterList"></div>
  </div>

  <!-- Main scroll area -->
  <div id="readerScroll">
    <div id="loadingState">
      <div class="icon">ğŸ“–</div>
      <h2>Open a Book to Begin</h2>
      <p>Select a book from the Library, or open an .lbk / .clbk file directly from your device.</p>
      <button class="open-file-btn" onclick="document.getElementById('fileInput').click()">
        ğŸ“‚ Open File
      </button>
      <input type="file" id="fileInput" accept=".lbk,.clbk" onchange="handleFileInput(this)">
    </div>
    <div id="readerContent" style="display:none; width:100%; max-width:100%; overflow-x:hidden;"></div>
    <div class="loader" id="loaderDots" style="display:none;">
      <span></span><span></span><span></span>
    </div>
  </div>

  <!-- Music bar -->
  <div id="musicBar">
    <span class="music-icon">ğŸµ</span>
    <span class="music-label" id="musicLabel">Background music</span>
    <button class="music-btn" id="musicToggle" onclick="toggleMusic()">â¸</button>
    <audio id="musicAudio" loop></audio>
  </div>

</div>
<div id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
// â”€â”€ Music observer â€” switches track when a new chapter scrolls into view â”€â”€
// Tracks whichever chapter card occupies the most vertical screen real estate.
let _currentMusicUrl = null;

const MusicObserver = new IntersectionObserver((entries) => {
  // Find the entry with the highest intersectionRatio that has music
  let best = null;
  entries.forEach(entry => {
    if (!entry.target.dataset.musicUrl) return;
    if (!best || entry.intersectionRatio > best.intersectionRatio) best = entry;
  });
  if (!best || best.intersectionRatio <= 0) return;

  const url   = best.target.dataset.musicUrl;
  const loop  = best.target.dataset.musicLoop === '1';
  const vol   = parseFloat(best.target.dataset.musicVol  || 0.7);
  const title = best.target.dataset.musicTitle || '';

  if (url === _currentMusicUrl) return; // already playing this track
  _currentMusicUrl = url;

  const audio = document.getElementById('musicAudio');
  const wasPlaying = !audio.paused;
  audio.pause();
  audio.src    = url;
  audio.loop   = loop;
  audio.volume = vol;
  document.getElementById('musicLabel').textContent = 'â™ª ' + title;
  document.getElementById('musicBar').classList.add('visible');
  document.getElementById('musicToggle').textContent = 'â¸';
  // Auto-play: always start the new track (chapter music should play when in view)
  audio.play().catch(() => {
    document.getElementById('musicToggle').textContent = 'â–¶';
  });
}, {
  root: null,                                    // viewport â€” works before DOM is ready
  rootMargin: '-10% 0px -10% 0px',              // chapter must occupy central 80% of screen
  threshold: [0, 0.1, 0.25, 0.5],
});

// â”€â”€ LBK / CLBK JavaScript Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Mirrors the Python lbk.py logic exactly.

const LBKReader = {

  // Parse a single .lbk ZIP â†’ { content, assets }
  // assets: { 'assets/gif_xxx.gif': ObjectURL, 'music/track.mp3': ObjectURL }
  async parseLBK(arrayBuffer) {
    const zip  = await JSZip.loadAsync(arrayBuffer);
    const json = await zip.file('content.json').async('string');
    const content = JSON.parse(json);
    const assets  = {};
    for (const [name, entry] of Object.entries(zip.files)) {
      if (name === 'content.json') continue;
      if (entry.dir) continue;
      const blob = await entry.async('blob');
      assets[name] = URL.createObjectURL(blob);
    }
    return { content, assets };
  },

  // Parse a .clbk bundle â†’ array of { title, content, assets }
  async parseCLBK(arrayBuffer) {
    const zip = await JSZip.loadAsync(arrayBuffer);
    const manifestStr = await zip.file('manifest.json').async('string');
    const manifest = JSON.parse(manifestStr);
    const chapters = [];
    const sorted = (manifest.chapters || []).slice().sort((a,b) => a.order - b.order);
    for (const ch of sorted) {
      const lbkEntry = zip.file(ch.filename);
      if (!lbkEntry) continue;
      const lbkBuf = await lbkEntry.async('arraybuffer');
      const { content, assets } = await LBKReader.parseLBK(lbkBuf);
      chapters.push({ title: ch.title || content.meta?.title || ch.filename, content, assets });
    }
    return { meta: manifest.meta, chapters };
  },
};

// â”€â”€ Renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Renderer = {
  fontScale: 1.0,
  chapters:  [],
  musicAudios: [],

  // Render entire book into #readerContent
  renderBook(data, isClbk) {
    const container = document.getElementById('readerContent');
    container.innerHTML = '';
    container.style.display = 'block';
    this.chapters = [];
    this.stopAllMusic();

    const items = isClbk ? data.chapters : [{ title: data.content.meta?.title || 'Chapter 1', content: data.content, assets: data.assets }];

    items.forEach((ch, i) => {
      if (i > 0) {
        const div = document.createElement('div');
        div.className = 'chapter-divider';
        container.appendChild(div);
      }
      const card = this.renderChapter(ch, i);
      container.appendChild(card);
      this.chapters.push({ title: ch.title, el: card });
    });

    this.buildChapterList();
    this.applyFontScale();
  },

  renderChapter({ title, content, assets }, idx) {
    const ps      = content.page_style  || {};
    const music   = content.music       || {};
    const spans   = content.spans       || [];
    const defBold = content.default_style?.bold || false;

    const bgColor   = ps.bg_color    || '#f5f4f0';
    const textColor = ps.text_color  || '#1a1a1a';
    const paraGap   = ps.line_spacing || 8;
    const gifGap    = ps.gif_spacing  || 12;

    const card = document.createElement('div');
    card.className = 'chapter-card';
    card.id = 'chapter-' + idx;
    card.style.cssText += `--para-gap:${paraGap}px; --gif-gap:${gifGap}px;`;
    card.style.background = bgColor;
    card.style.color = textColor;

    // Heading
    if (title) {
      const h = document.createElement('div');
      h.className = 'chapter-heading';
      h.textContent = title;
      h.style.color = textColor;
      card.appendChild(h);
    }

    // Music (if present)
    if (music.src) {
      const audioUrl = assets[music.src];
      if (audioUrl) {
        this.setupMusic(audioUrl, music, card, title, idx);
      }
    }

    // Group spans into paragraphs
    const paras = this.groupParas(spans);
    paras.forEach(para => {
      if (para.type === 'gif') {
        const wrap = document.createElement('div');
        wrap.className = 'gif-wrap';
        const url = assets[para.src];
        if (url) {
          const img = document.createElement('img');
          img.src = url; img.alt = para.alt || '';
          img.style.width  = para.width  ? Math.min(para.width, 600) + 'px'  : 'auto';
          img.style.height = para.height ? Math.min(para.height, 400) + 'px' : 'auto';
          wrap.appendChild(img);
        } else {
          wrap.textContent = '[Image not found]';
          wrap.style.color = '#cc4444';
          wrap.style.fontSize = '.8rem';
        }
        card.appendChild(wrap);
      } else {
        // Text paragraph
        const p = document.createElement('p');
        p.className = 'text-paragraph';
        para.runs.forEach(run => {
          const span = document.createElement('span');
          span.textContent = run.content;
          span.style.color = run.style?.color || textColor;
          if (run.style?.font_size) span.dataset.fontSize = run.style.font_size;
          if (run.style?.bold    || defBold) span.classList.add('span-bold');
          if (run.style?.italic)             span.classList.add('span-italic');
          if (run.style?.underline)          span.classList.add('span-underline');
          if (run.style?.font_family && run.style.font_family !== 'Default') {
            span.style.fontFamily = `'${run.style.font_family}', serif`;
          }
          p.appendChild(span);
        });
        card.appendChild(p);
      }
    });

    return card;
  },

  // Group spans into paragraph objects
  groupParas(spans) {
    const result = [];
    let currentRuns = [];
    for (const sp of spans) {
      if (sp.type === 'gif') {
        if (currentRuns.length) { result.push({ type:'text', runs: currentRuns }); currentRuns = []; }
        result.push({ type:'gif', ...sp });
        continue;
      }
      // text span
      const run = { content: sp.content, style: sp.style };
      currentRuns.push(run);
      if (sp.paragraph_end) {
        result.push({ type:'text', runs: currentRuns });
        currentRuns = [];
      }
    }
    if (currentRuns.length) result.push({ type:'text', runs: currentRuns });
    return result;
  },

  // Music setup â€” store track info on the card element, observer handles switching
  setupMusic(url, musicMeta, card, title, idx) {
    // Tag the card so the IntersectionObserver can read its music config
    card.dataset.musicUrl    = url;
    card.dataset.musicLoop   = musicMeta.loop !== false ? '1' : '0';
    card.dataset.musicVol    = musicMeta.volume ?? 0.7;
    card.dataset.musicTitle  = title;

    // Observe this card â€” when it becomes the most-visible chapter, switch music
    MusicObserver.observe(card);

    this.musicAudios.push({ url, title });
  },

  stopAllMusic() {
    const audio = document.getElementById('musicAudio');
    audio.pause(); audio.src = '';
    document.getElementById('musicBar').classList.remove('visible');
    this.musicAudios = [];
    MusicObserver.disconnect();
  },

  // Chapter list in drawer
  buildChapterList() {
    const list = document.getElementById('chapterList');
    list.innerHTML = '';
    this.chapters.forEach((ch, i) => {
      const item = document.createElement('div');
      item.className = 'chapter-item' + (i === 0 ? ' active' : '');
      item.textContent = (i + 1) + '. ' + ch.title;
      item.onclick = () => {
        ch.el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        document.querySelectorAll('.chapter-item').forEach(x => x.classList.remove('active'));
        item.classList.add('active');
        closeDrawer();
      };
      list.appendChild(item);
    });
  },

  applyFontScale() {
    document.querySelectorAll('.text-paragraph').forEach(p => {
      p.querySelectorAll('span').forEach(sp => {
        const base = parseFloat(sp.dataset.fontSize || 16);
        sp.style.fontSize = (base * this.fontScale) + 'px';
      });
    });
  },
};

// â”€â”€ File loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFile(arrayBuffer, filename) {
  showLoader(true);
  try {
    const lower = filename.toLowerCase();
    let bookData, isClbk = false;
    if (lower.endsWith('.clbk')) {
      bookData = await LBKReader.parseCLBK(arrayBuffer);
      isClbk = true;
      document.getElementById('readerBookTitle').textContent = bookData.meta?.title || filename;
    } else {
      bookData = await LBKReader.parseLBK(arrayBuffer);
      document.getElementById('readerBookTitle').textContent = bookData.content?.meta?.title || filename;
    }
    document.getElementById('loadingState').style.display = 'none';
    Renderer.renderBook(bookData, isClbk);
    showToast('ğŸ“– Book loaded');
  } catch(e) {
    console.error(e);
    showToast('âš  Could not load file: ' + e.message);
  } finally {
    showLoader(false);
  }
}

function handleFileInput(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => loadFile(e.target.result, file.name);
  reader.readAsArrayBuffer(file);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ CORS Proxy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GitHub Release URLs can't be fetched directly by browsers (no CORS headers).
// We route them through a Cloudflare Worker you deploy once â€” it's free and
// handles files of any size. See the deployment guide for setup instructions.
// Once deployed, paste your worker URL here:
const CORS_PROXY = 'https://web-production-a6ac9.up.railway.app/proxy?url=';

// â”€â”€ URL resolver â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns the best fetchable URL. Rewrites GitHub patterns, proxies releases.
function resolveUrl(url) {
  if (!url) return null;

  // raw.githubusercontent.com â€” CORS is fine, use directly
  if (/raw\.githubusercontent\.com/i.test(url)) return url;

  // github.com/user/repo/blob/branch/path â†’ rewrite to raw (CORS is fine)
  const blobMatch = url.match(/github\.com\/([^/]+)\/([^/]+)\/blob\/([^/]+)\/(.+)/i);
  if (blobMatch) {
    const [,user,repo,branch,path] = blobMatch;
    return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
  }

  // GitHub Release URL â€” must go through proxy (no CORS on their CDN)
  if (/github\.com\/[^/]+\/[^/]+\/releases\/download\//i.test(url)) {
    const proxyReady = CORS_PROXY && !CORS_PROXY.includes('YOUR-SUBDOMAIN');
    if (proxyReady) {
      return `${CORS_PROXY}?url=${encodeURIComponent(url)}`;
    }
    return null; // proxy not yet configured
  }

  // Any other https â€” try directly
  if (/^https?:\/\//i.test(url)) return url;

  return null; // local / relative path
}

// â”€â”€ Load from sessionStorage (set by Main.html) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ Navigation helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Auto-detects the base path so navigation works whether the site is at
// https://user.github.io/ (root) or https://user.github.io/reponame/ (subfolder).
const _basePath = (() => {
  const p = window.location.pathname;
  // Find the directory containing the current .html file
  const dir = p.substring(0, p.lastIndexOf('/'));
  return dir; // e.g. '' or '/the-shelf'
})();
function nav(page) {
  window.location.href = _basePath + '/' + page;
}
function navHref(page) {
  return _basePath + '/' + page;
}
// Rewrite all nav links once DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('a[data-page]').forEach(a => {
    a.href = navHref(a.dataset.page);
  });
});

window.addEventListener('DOMContentLoaded', () => {
  const bookJson = sessionStorage.getItem('pending_book');
  if (!bookJson) return;
  const book = JSON.parse(bookJson);
  sessionStorage.removeItem('pending_book');

  if (book.title) document.getElementById('readerBookTitle').textContent = book.title;

  const rawUrl  = book.file || '';
  const fetchUrl = resolveUrl(rawUrl);

  if (!fetchUrl) {
    // Proxy not configured yet â€” show setup instructions inline
    const isRelease = /github\.com\/[^/]+\/[^/]+\/releases\/download\//i.test(rawUrl);
    const ls = document.getElementById('loadingState');
    ls.style.display = 'block';
    if (isRelease) {
      ls.querySelector('h2').textContent = 'âš™ Proxy Not Set Up Yet';
      ls.querySelector('p').innerHTML =
        `<strong>${escHtml(book.title || 'This book')}</strong> is on GitHub Releases, `
        + `which requires a CORS proxy to fetch in-browser.<br><br>`
        + `<b>Quick fix:</b> Deploy the free Cloudflare Worker from the guide, `
        + `then paste your worker URL into <code>CORS_PROXY</code> at the top of reader.html.<br><br>`
        + `<b>For now:</b> `
        + `<a href="${escHtml(rawUrl)}" target="_blank" style="color:var(--green);font-weight:600">`
        + `Download the file</a>, then tap <b>Open File</b> below.`;
    } else {
      ls.querySelector('h2').textContent = 'Open "' + escHtml(book.title || 'book') + '"';
      ls.querySelector('p').textContent  = 'Tap "Open File" and select the .lbk or .clbk file.';
    }
    return;
  }

  // Fetch the file (directly or via proxy)
  showLoader(true);
  document.getElementById('loadingState').style.display = 'none';

  fetch(fetchUrl)
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status} â€” ${r.statusText}`);
      return r.arrayBuffer();
    })
    .then(buf => loadFile(buf, rawUrl)) // use original filename for extension detection
    .catch(e => {
      showLoader(false);
      const ls = document.getElementById('loadingState');
      ls.style.display = 'block';
      ls.querySelector('h2').textContent = 'âš  Download Failed';
      ls.querySelector('p').innerHTML =
        `Could not fetch <em>${escHtml(book.title || 'book')}</em>: ${escHtml(e.message)}<br><br>`
        + `You can still read it: `
        + `<a href="${escHtml(rawUrl)}" target="_blank" style="color:var(--green)">download the file</a>`
        + ` then tap <b>Open File</b> below.`;
    });
});

// â”€â”€ UI controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goBack() { nav('Main.html'); }

function toggleDrawer() {
  const d = document.getElementById('chapterDrawer');
  const btn = document.getElementById('btnChapters');
  const open = d.classList.toggle('open');
  btn.classList.toggle('active', open);
  // Close font panel
  document.getElementById('fontPanel').classList.remove('open');
  document.getElementById('btnFont').classList.remove('active');
}
function closeDrawer() {
  document.getElementById('chapterDrawer').classList.remove('open');
  document.getElementById('btnChapters').classList.remove('active');
}

function toggleFontPanel() {
  const p = document.getElementById('fontPanel');
  const btn = document.getElementById('btnFont');
  const open = p.classList.toggle('open');
  btn.classList.toggle('active', open);
  // Close chapter drawer
  document.getElementById('chapterDrawer').classList.remove('open');
  document.getElementById('btnChapters').classList.remove('active');
}

let fontSize = 16;
function adjustFont(delta) {
  fontSize = Math.min(24, Math.max(12, fontSize + delta));
  document.getElementById('fpSize').textContent = fontSize;
  Renderer.fontScale = fontSize / 16;
  Renderer.applyFontScale();
}

function toggleMusic() {
  const audio = document.getElementById('musicAudio');
  const btn   = document.getElementById('musicToggle');
  if (audio.paused) { audio.play(); btn.textContent = 'â¸'; }
  else              { audio.pause(); btn.textContent = 'â–¶'; }
}

// Keyboard: Escape â†’ back
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (document.getElementById('chapterDrawer').classList.contains('open')) { closeDrawer(); return; }
    goBack();
  }
});

// Close panels on outside click
document.addEventListener('click', e => {
  const drawer = document.getElementById('chapterDrawer');
  const font   = document.getElementById('fontPanel');
  if (!drawer.contains(e.target) && !document.getElementById('btnChapters').contains(e.target))
    drawer.classList.remove('open');
  if (!font.contains(e.target)   && !document.getElementById('btnFont').contains(e.target))
    font.classList.remove('open');
});

function showLoader(show) {
  document.getElementById('loaderDots').style.display = show ? 'flex' : 'none';
}

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2600);
}
</script>
</body>
</html>
