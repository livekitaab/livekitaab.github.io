<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LiveKitaab â€” My Account</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Lora:ital,wght@0,400;0,500;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --brown:       #a46636;
    --brown-deep:  #7a4a22;
    --brown-dark:  #3b2010;
    --green:       #6bbf8e;
    --green-light: #a2d5a1;
    --green-dark:  #3d7a56;
    --cream:       #f6e9d7;
    --cream-dark:  #ecdcc4;
    --cream-deeper:#e0cdb0;
    --gold:        #f7e7b5;
    --gold-deep:   #d4a853;
    --text-dark:   #2a1a0e;
    --text-mid:    #5c3d1e;
    --text-light:  #8c6a45;
    --shadow-sm:   0 2px 8px rgba(58,28,8,.10);
    --shadow-md:   0 4px 20px rgba(58,28,8,.14);
    --shadow-lg:   0 8px 40px rgba(58,28,8,.18);
    --radius:      12px;
    --radius-sm:   8px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--text-dark);
    min-height: 100vh;
    overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed; inset: 0; pointer-events: none; z-index: 0;
    opacity: .035;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  }
  #app { position: relative; z-index: 1; min-height: 100vh; display: flex; flex-direction: column; }

  /* â”€â”€ Top nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .topnav {
    background: var(--brown-dark);
    padding: 0 24px; height: 52px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 2px 10px rgba(0,0,0,.35);
    position: sticky; top: 0; z-index: 100;
  }
  .topnav-brand {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem; font-weight: 700;
    color: var(--gold); letter-spacing: .02em; text-decoration: none;
  }
  .topnav-links { display: flex; gap: 6px; align-items: center; }
  .topnav-links a {
    color: var(--cream); font-size: .82rem; text-decoration: none;
    padding: 5px 12px; border-radius: 20px; transition: background .2s, color .2s;
  }
  .topnav-links a:hover { background: rgba(246,233,215,.12); color: var(--gold); }
  .topnav-links .active { color: var(--gold); }

  /* â”€â”€ Page layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page-wrap { max-width: 700px; margin: 0 auto; padding: 32px 16px 80px; }

  /* â”€â”€ NEW SUBSCRIPTION WELCOME BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .new-sub-banner {
    background: linear-gradient(120deg, var(--green-dark) 0%, var(--green) 60%, var(--gold-deep) 100%);
    border-radius: var(--radius); margin: 0 16px 24px;
    padding: 20px 22px; display: none;
    box-shadow: 0 4px 24px rgba(61,122,86,.35);
    position: relative; overflow: hidden;
  }
  .new-sub-banner.show { display: flex; align-items: flex-start; gap: 14px; }
  .new-sub-banner::after {
    content: 'â­'; position: absolute; right: 8px; bottom: -8px;
    font-size: 72px; opacity: .12; pointer-events: none;
  }
  .new-sub-banner-icon { font-size: 2rem; flex-shrink: 0; margin-top: 2px; }
  .new-sub-banner-text h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem; font-weight: 700; color: var(--brown-dark); margin-bottom: 4px;
  }
  .new-sub-banner-text p { font-size: .82rem; color: var(--brown-deep); line-height: 1.5; }

  /* â”€â”€ Auth banner (when logged out) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .auth-banner {
    background: linear-gradient(120deg, var(--green) 0%, var(--green-light) 55%, var(--gold-deep) 100%);
    padding: 32px 28px 28px;
    border-radius: 0 0 var(--radius) var(--radius);
    margin-bottom: 28px;
    position: relative; overflow: hidden;
  }
  .auth-banner::after {
    content: 'ğŸ”–'; position: absolute; right: -8px; bottom: -14px;
    font-size: 80px; opacity: .12; pointer-events: none; transform: rotate(-6deg);
  }
  .auth-banner h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(1.3rem, 4vw, 1.7rem); font-weight: 900;
    color: var(--brown-dark); margin-bottom: 5px;
  }
  .auth-banner p {
    font-family: 'Lora', serif; font-style: italic;
    color: var(--brown-deep); font-size: .88rem;
  }

  /* â”€â”€ Auth card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .auth-card {
    background: white; border-radius: var(--radius);
    box-shadow: var(--shadow-md); padding: 28px 24px;
    margin-bottom: 20px;
  }
  .auth-tabs { display: flex; margin-bottom: 24px; border-bottom: 2px solid var(--cream-deeper); }
  .auth-tab {
    flex: 1; padding: 10px; text-align: center;
    font-size: .88rem; font-weight: 500; cursor: pointer;
    color: var(--text-light); border: none; background: transparent;
    border-bottom: 3px solid transparent; margin-bottom: -2px;
    transition: all .18s;
  }
  .auth-tab.active { color: var(--brown); border-bottom-color: var(--brown); }

  .auth-form { display: none; }
  .auth-form.active { display: block; }

  .form-group { margin-bottom: 16px; }
  .form-label {
    display: block; font-size: .78rem; font-weight: 500;
    color: var(--text-light); text-transform: uppercase;
    letter-spacing: .06em; margin-bottom: 6px;
  }
  .form-input {
    width: 100%; padding: 10px 14px; border-radius: var(--radius-sm);
    border: 1.5px solid var(--cream-deeper); background: var(--cream);
    font-family: 'DM Sans', sans-serif; font-size: .88rem;
    color: var(--text-dark); outline: none; transition: border-color .18s;
  }
  .form-input:focus { border-color: var(--green); background: white; }
  .form-input::placeholder { color: var(--text-light); }
  /* Highlight email field when pre-filled from sub flow */
  .form-input.prefilled { border-color: var(--green); background: white; }

  .btn-full {
    width: 100%; padding: 11px; border: none; border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif; font-size: .9rem; font-weight: 500;
    cursor: pointer; transition: all .18s; margin-top: 4px;
  }
  .btn-submit { background: var(--brown); color: var(--cream); }
  .btn-submit:hover { background: var(--brown-deep); }
  .btn-submit:active { transform: scale(.98); }
  /* Green submit when coming from subscription */
  .btn-submit.sub-mode { background: var(--green-dark); }
  .btn-submit.sub-mode:hover { background: var(--green); color: var(--brown-dark); }

  .form-footer {
    font-size: .78rem; color: var(--text-light);
    text-align: center; margin-top: 14px;
    font-family: 'Lora', serif; font-style: italic;
  }
  .form-error {
    font-size: .8rem; color: #c0392b; margin-top: 8px;
    padding: 8px 12px; background: #fdf0ee;
    border-radius: var(--radius-sm); display: none;
  }
  .form-error.show { display: block; }

  /* â”€â”€ Profile view (logged in) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #profileView { display: none; }

  .profile-header {
    background: linear-gradient(120deg, var(--green) 0%, var(--green-light) 55%, var(--gold-deep) 100%);
    padding: 28px 24px;
    border-radius: 0 0 var(--radius) var(--radius);
    margin-bottom: 24px;
    display: flex; align-items: center; gap: 18px;
    position: relative; overflow: hidden;
  }
  .profile-header::after {
    content: 'ğŸ“š'; position: absolute; right: 8px; bottom: -12px;
    font-size: 72px; opacity: .10; pointer-events: none; transform: rotate(-4deg);
  }
  .avatar {
    width: 58px; height: 58px; border-radius: 50%;
    background: var(--brown-dark);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; color: var(--gold);
    font-family: 'Playfair Display', serif; font-weight: 700;
    flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,.2);
  }
  .profile-info h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem; font-weight: 700; color: var(--brown-dark);
  }
  .profile-info p { font-size: .82rem; color: var(--brown-deep); margin-top: 2px; }
  .profile-info small { font-size: .72rem; color: var(--brown-deep); font-style: italic; }

  /* â”€â”€ Subscription badge in profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sub-badge {
    display: inline-flex; align-items: center; gap: 5px;
    background: var(--brown-dark); color: var(--gold);
    font-size: .72rem; font-weight: 600; padding: 3px 10px;
    border-radius: 12px; margin-top: 5px;
  }
  .sub-badge.active { background: var(--green-dark); color: white; }

  /* â”€â”€ Section cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-card {
    background: white; border-radius: var(--radius);
    box-shadow: var(--shadow-sm); padding: 22px 20px;
    margin-bottom: 16px;
  }
  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: .95rem; font-weight: 700; color: var(--text-dark);
    margin-bottom: 16px; padding-bottom: 10px;
    border-bottom: 1px solid var(--cream-deeper);
    display: flex; align-items: center; gap: 8px;
  }

  /* â”€â”€ Owned books list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .owned-list { display: flex; flex-direction: column; gap: 10px; }
  .owned-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px; border-radius: var(--radius-sm);
    background: var(--cream); cursor: pointer;
    transition: background .15s;
  }
  .owned-item:hover { background: var(--cream-dark); }
  .owned-thumb {
    width: 38px; height: 52px; border-radius: 5px;
    background: linear-gradient(135deg, var(--brown) 0%, var(--brown-deep) 100%);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; flex-shrink: 0;
  }
  .owned-info { flex: 1; min-width: 0; }
  .owned-title {
    font-family: 'Playfair Display', serif;
    font-size: .88rem; font-weight: 600;
    color: var(--text-dark); overflow: hidden;
    text-overflow: ellipsis; white-space: nowrap;
  }
  .owned-meta { font-size: .72rem; color: var(--text-light); margin-top: 2px; }
  .owned-read-btn {
    padding: 5px 14px; border-radius: 14px; border: none;
    background: var(--green); color: var(--brown-dark);
    font-size: .76rem; font-weight: 500; cursor: pointer;
    transition: background .15s; white-space: nowrap;
  }
  .owned-read-btn:hover { background: var(--green-dark); color: white; }
  .empty-owned {
    text-align: center; padding: 30px 20px;
    color: var(--text-light); font-family: 'Lora', serif; font-style: italic;
    font-size: .88rem;
  }
  .empty-owned span { display: block; font-size: 1.8rem; margin-bottom: 8px; }

  /* â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  .stat-box {
    background: var(--cream); border-radius: var(--radius-sm);
    padding: 14px 10px; text-align: center;
  }
  .stat-num {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem; font-weight: 700; color: var(--brown);
  }
  .stat-label { font-size: .7rem; color: var(--text-light); margin-top: 3px; text-transform: uppercase; letter-spacing: .06em; }

  /* â”€â”€ Subscription info card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sub-info-card {
    background: linear-gradient(120deg, rgba(107,191,142,.12) 0%, rgba(162,213,161,.08) 100%);
    border: 1.5px solid var(--green);
    border-radius: var(--radius); padding: 16px 18px;
    display: flex; align-items: center; gap: 14px; margin-bottom: 16px;
  }
  .sub-info-icon { font-size: 1.8rem; flex-shrink: 0; }
  .sub-info-text h4 {
    font-family: 'Playfair Display', serif;
    font-size: .9rem; font-weight: 700; color: var(--green-dark); margin-bottom: 3px;
  }
  .sub-info-text p { font-size: .78rem; color: var(--text-light); }
  .sub-info-expired {
    border-color: var(--cream-deeper);
    background: rgba(0,0,0,.02);
  }
  .sub-info-expired .sub-info-text h4 { color: var(--text-light); }

  /* â”€â”€ Danger zone / settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .setting-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 0; border-bottom: 1px solid var(--cream-dark);
  }
  .setting-row:last-child { border-bottom: none; }
  .setting-label { font-size: .85rem; color: var(--text-mid); }
  .setting-value { font-size: .82rem; color: var(--text-light); }
  .btn-sm {
    padding: 5px 14px; border-radius: 14px; border: none;
    font-size: .78rem; font-weight: 500; cursor: pointer; transition: all .15s;
  }
  .btn-outline-brown { background: transparent; border: 1.5px solid var(--brown); color: var(--brown); }
  .btn-outline-brown:hover { background: var(--brown); color: white; }
  .btn-danger { background: transparent; border: 1.5px solid #e05b5b; color: #e05b5b; }
  .btn-danger:hover { background: #e05b5b; color: white; }

  .sign-out-wrap { text-align: center; margin-top: 24px; }
  .btn-signout {
    background: transparent; border: 1.5px solid var(--cream-deeper);
    color: var(--text-light); padding: 9px 28px; border-radius: 24px;
    font-family: 'DM Sans', sans-serif; font-size: .84rem;
    cursor: pointer; transition: all .18s;
  }
  .btn-signout:hover { border-color: var(--brown); color: var(--brown); }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(60px);
    background: var(--brown-dark); color: var(--cream);
    padding: 9px 22px; border-radius: 30px; font-size: .82rem;
    box-shadow: var(--shadow-md); transition: transform .3s ease; z-index: 999; white-space: nowrap;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div id="app">

  <!-- Top nav -->
  <nav class="topnav">
    <a class="topnav-brand" href="#" data-page="Main.html">
      <span style="color:#ffffff;font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;">Live</span><span style="color:#f7e7b5;font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;">Kitaab</span>
    </a>
    <div class="topnav-links">
      <a href="#" data-page="Main.html">Library</a>
      <a href="#" data-page="Reader.html">Reader</a>
      <a class="active" href="#" data-page="Account.html">Account</a>
    </div>
  </nav>

  <!-- â”€â”€ LOGGED-OUT VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="authView">

    <!-- Welcome banner â€” shown for everyone, enhanced when coming from subscription -->
    <div class="auth-banner" id="authBanner">
      <h1 id="authBannerTitle">Welcome to <span style="color:#fff;">Live</span><span style="color:#fff;">Kitaab</span></h1>
      <p id="authBannerSub">Sign in to access your library &amp; books</p>
    </div>

    <!-- New subscription welcome strip â€” shown only after payment approval -->
    <div class="new-sub-banner" id="newSubBanner">
      <div class="new-sub-banner-icon">ğŸ‰</div>
      <div class="new-sub-banner-text">
        <h3>Subscription Approved!</h3>
        <p id="newSubBannerText">Your â‚¹200 payment has been verified. Create your account below to lock in your 30-day access â€” it will follow you on every device.</p>
      </div>
    </div>

    <div class="page-wrap" style="padding-top:0;">
      <div class="auth-card">
        <div class="auth-tabs">
          <button class="auth-tab" id="tab-login"    onclick="switchAuthTab('login',this)">Sign In</button>
          <button class="auth-tab" id="tab-register" onclick="switchAuthTab('register',this)">Create Account</button>
        </div>

        <!-- Login form -->
        <div class="auth-form" id="form-login">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input class="form-input" id="login-email" type="email" placeholder="you@example.com" autocomplete="email">
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input class="form-input" id="login-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
          </div>
          <div class="form-error" id="login-error"></div>
          <button class="btn-full btn-submit" id="login-btn" onclick="handleLogin()">Sign In â†’</button>
          <p class="form-footer">Forgot password? <a href="#" style="color:var(--brown);text-decoration:none;" onclick="showForgot()">Reset it</a></p>
        </div>

        <!-- Register form -->
        <div class="auth-form" id="form-register">
          <div class="form-group">
            <label class="form-label">Full Name</label>
            <input class="form-input" id="reg-name" type="text" placeholder="Your name" autocomplete="name">
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input class="form-input" id="reg-email" type="email" placeholder="you@example.com" autocomplete="email">
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input class="form-input" id="reg-pass" type="password" placeholder="Min. 8 characters" autocomplete="new-password">
          </div>
          <div class="form-group">
            <label class="form-label">Confirm Password</label>
            <input class="form-input" id="reg-pass2" type="password" placeholder="Repeat password" autocomplete="new-password">
          </div>
          <div class="form-error" id="reg-error"></div>
          <button class="btn-full btn-submit" id="reg-btn" onclick="handleRegister()">Create Account â†’</button>
          <p class="form-footer">By registering you agree to our Terms &amp; Privacy Policy.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ LOGGED-IN VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="profileView">
    <div class="profile-header">
      <div class="avatar" id="avatarInitials">?</div>
      <div class="profile-info">
        <h2 id="profileName">Reader</h2>
        <p id="profileEmail">â€“</p>
        <small id="profileJoined"></small>
        <div id="profileSubBadge"></div>
      </div>
    </div>

    <div class="page-wrap" style="padding-top:0;">

      <!-- Subscription info card -->
      <div id="subInfoCard"></div>

      <!-- Stats -->
      <div class="section-card">
        <div class="section-title">ğŸ“Š Your Reading</div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-num" id="statOwned">0</div>
            <div class="stat-label">Free Books</div>
          </div>
          <div class="stat-box">
            <div class="stat-num" id="statSubDays">â€“</div>
            <div class="stat-label">Days Left</div>
          </div>
          <div class="stat-box">
            <div class="stat-num" id="statSpent">â‚¹0</div>
            <div class="stat-label">Spent</div>
          </div>
        </div>
      </div>

      <!-- Owned books -->
      <div class="section-card">
        <div class="section-title">ğŸ“š My Library</div>
        <div class="owned-list" id="ownedList">
          <div class="empty-owned"><span>ğŸŒ¿</span>Loading your booksâ€¦</div>
        </div>
      </div>

      <!-- Account settings -->
      <div class="section-card">
        <div class="section-title">âš™ Account</div>
        <div class="setting-row">
          <span class="setting-label">Email</span>
          <span class="setting-value" id="settingEmail">â€“</span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Password</span>
          <button class="btn-sm btn-outline-brown" onclick="showChangePassword()">Change</button>
        </div>
        <div class="setting-row">
          <span class="setting-label">Reading data</span>
          <button class="btn-sm btn-danger" onclick="clearData()">Clear</button>
        </div>
      </div>

      <div class="sign-out-wrap">
        <button class="btn-signout" onclick="signOut()">Sign Out</button>
      </div>
    </div>
  </div>

</div><!-- #app -->
<div id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey:            "AIzaSyAOUx2hi5LMebUVc_vlGQ_QEkBeMjQaaMo",
  authDomain:        "livekitaab.firebaseapp.com",
  projectId:         "livekitaab",
  storageBucket:     "livekitaab.firebasestorage.app",
  messagingSenderId: "387850236053",
  appId:             "1:387850236053:web:babf8596ac3841aeddeb9c",
  measurementId:     "G-1RY50RP54G"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _basePath = (() => {
  const p = window.location.pathname;
  return p.substring(0, p.lastIndexOf('/'));
})();
function nav(page) { window.location.href = _basePath + '/' + page; }
function navHref(page) { return _basePath + '/' + page; }

// â”€â”€ Subscription helpers (mirrors Main.html) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUB_KEY = 'lk_sub';
function getLocalSub() {
  try { return JSON.parse(localStorage.getItem(SUB_KEY) || 'null'); } catch { return null; }
}
function isLocalSubActive() {
  const sub = getLocalSub();
  if (!sub || !sub.expiry) return false;
  return new Date(sub.expiry) > new Date();
}
function getSubDaysLeft() {
  const sub = getLocalSub();
  if (!sub || !sub.expiry) return 0;
  return Math.max(0, Math.ceil((new Date(sub.expiry) - new Date()) / 86400000));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEW SUBSCRIPTION FLOW
//  If Main.html redirected here after approval, sessionStorage
//  will have 'lk_new_sub'. We use that to:
//  1. Show the green welcome banner
//  2. Switch to the Register tab automatically
//  3. After account creation, write subscription to Firestore
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _newSubData = null; // set if user just subscribed

function checkNewSubFlag() {
  try {
    const raw = sessionStorage.getItem('lk_new_sub');
    if (!raw) return;
    _newSubData = JSON.parse(raw);
    // Don't remove yet â€” keep it for the register handler
  } catch { _newSubData = null; }
}

function applyNewSubUI() {
  if (!_newSubData) return;

  // Show green welcome banner
  const banner = document.getElementById('newSubBanner');
  if (banner) {
    document.getElementById('newSubBannerText').textContent =
      `Your â‚¹200 payment has been verified. Create your account below to lock in your ${_newSubData.days || 30}-day access â€” your subscription will sync to every device you sign in on.`;
    banner.classList.add('show');
  }

  // Update auth banner to feel like a welcome
  document.getElementById('authBannerTitle').textContent = 'ğŸ‰ Payment Approved!';
  document.getElementById('authBannerSub').textContent =
    'One last step â€” create your account to activate your subscription.';

  // Switch to register tab automatically
  const regTab = document.getElementById('tab-register');
  if (regTab) switchAuthTab('register', regTab);

  // Highlight the register button green
  const regBtn = document.getElementById('reg-btn');
  if (regBtn) {
    regBtn.classList.add('sub-mode');
    regBtn.textContent = 'Create Account & Activate Subscription â†’';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  // Rewrite nav links
  document.querySelectorAll('a[data-page]').forEach(a => {
    a.href = navHref(a.dataset.page);
  });

  // Check for new-subscription flag before Firebase resolves
  checkNewSubFlag();

  // Hide both views while Firebase resolves auth state
  document.getElementById('authView').style.display    = 'none';
  document.getElementById('profileView').style.display = 'none';

  auth.onAuthStateChanged(async user => {
    if (user) {
      // If there's a pending new subscription, write it to Firestore first
      if (_newSubData) {
        await writeSubToFirestore(user, _newSubData);
        sessionStorage.removeItem('lk_new_sub');
        _newSubData = null;
        showToast('â­ Subscription activated!');
      }
      showProfile(user);
    } else {
      showAuth();
      // Apply new-sub UI after auth view is shown
      if (_newSubData) applyNewSubUI();
    }
  });
});

// â”€â”€ Show / hide views â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAuth() {
  document.getElementById('authView').style.display    = 'block';
  document.getElementById('profileView').style.display = 'none';
}

async function showProfile(user) {
  document.getElementById('authView').style.display    = 'none';
  document.getElementById('profileView').style.display = 'block';

  const profile = await loadFirestoreProfile(user);
  const name    = profile?.name || user.displayName || nameFromEmail(user.email);
  const joined  = user.metadata.creationTime;

  document.getElementById('profileName').textContent    = name;
  document.getElementById('profileEmail').textContent   = user.email;
  document.getElementById('settingEmail').textContent   = user.email;
  document.getElementById('avatarInitials').textContent = name.charAt(0).toUpperCase();
  if (joined) {
    document.getElementById('profileJoined').textContent =
      'Member since ' + new Date(joined).toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
  }

  // Resolve subscription â€” check Firestore first, fallback to localStorage
  const subInfo = await resolveSubscription(user, profile);
  renderSubUI(subInfo);
  renderStats(profile, subInfo);
  loadOwnedBooks(profile);
}

// â”€â”€ Resolve subscription from Firestore + localStorage â”€â”€â”€â”€â”€â”€â”€
async function resolveSubscription(user, profile) {
  // Firestore subscription takes priority
  const fsub = profile?.subscription;
  if (fsub?.expiry) {
    const expiry = new Date(fsub.expiry);
    const active = expiry > new Date();
    const days   = active ? Math.ceil((expiry - new Date()) / 86400000) : 0;
    // Sync back to localStorage so Main.html stays in sync
    if (active) {
      localStorage.setItem(SUB_KEY, JSON.stringify({
        code:   fsub.code || 'FIRESTORE',
        expiry: fsub.expiry
      }));
    }
    return { active, days, expiry, source: 'firestore' };
  }
  // Fallback: localStorage
  const local = getLocalSub();
  if (local?.expiry) {
    const expiry = new Date(local.expiry);
    const active = expiry > new Date();
    const days   = active ? Math.ceil((expiry - new Date()) / 86400000) : 0;
    // If active in localStorage, push it to Firestore
    if (active) await writeSubToFirestore(user, { code: local.code, days });
    return { active, days, expiry, source: 'local' };
  }
  return { active: false, days: 0 };
}

// â”€â”€ Write subscription to Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function writeSubToFirestore(user, subData) {
  try {
    const expiry = new Date();
    expiry.setDate(expiry.getDate() + (subData.days || 30));
    await db.collection('users').doc(user.uid).set({
      subscription: {
        code:       subData.code || 'APPROVED',
        days:       subData.days || 30,
        expiry:     expiry.toISOString(),
        activated:  new Date().toISOString(),
      },
      updated: firebase.firestore.FieldValue.serverTimestamp(),
    }, { merge: true });
    // Keep localStorage in sync
    localStorage.setItem(SUB_KEY, JSON.stringify({
      code:   subData.code,
      expiry: expiry.toISOString()
    }));
  } catch (e) { console.warn('Firestore sub write failed:', e); }
}

// â”€â”€ Render subscription UI in profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSubUI(subInfo) {
  // Badge on avatar card
  const badge = document.getElementById('profileSubBadge');
  if (subInfo.active) {
    badge.innerHTML = `<span class="sub-badge active">â­ Subscribed Â· ${subInfo.days} day${subInfo.days!==1?'s':''} left</span>`;
  } else {
    badge.innerHTML = `<span class="sub-badge">No active subscription</span>`;
  }

  // Subscription info card
  const card = document.getElementById('subInfoCard');
  if (subInfo.active) {
    const exp = subInfo.expiry ? new Date(subInfo.expiry).toLocaleDateString('en-IN',{day:'numeric',month:'long',year:'numeric'}) : 'â€“';
    card.innerHTML = `
      <div class="sub-info-card">
        <div class="sub-info-icon">â­</div>
        <div class="sub-info-text">
          <h4>Active Subscription</h4>
          <p>Full library access until ${exp} Â· ${subInfo.days} day${subInfo.days!==1?'s':''} remaining</p>
        </div>
      </div>`;
  } else {
    card.innerHTML = `
      <div class="sub-info-card sub-info-expired">
        <div class="sub-info-icon">ğŸ“–</div>
        <div class="sub-info-text">
          <h4>No Active Subscription</h4>
          <p>Subscribe for â‚¹200/month to unlock every book in the library.</p>
        </div>
      </div>`;
  }
}

function renderStats(profile, subInfo) {
  const freeBooks = []; // could count from library if needed
  document.getElementById('statOwned').textContent   = profile?.owned_ids?.length || 0;
  document.getElementById('statSubDays').textContent = subInfo.active ? subInfo.days : 'â€“';
  document.getElementById('statSpent').textContent   = subInfo.active ? 'â‚¹200' : 'â‚¹0';
}

// â”€â”€ Firestore: load user profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFirestoreProfile(user) {
  try {
    const doc = await db.collection('users').doc(user.uid).get();
    return doc.exists ? doc.data() : null;
  } catch { return null; }
}

// â”€â”€ Firestore: save / merge user profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveFirestoreProfile(user, name) {
  try {
    await db.collection('users').doc(user.uid).set({
      name,
      email:   user.email,
      updated: firebase.firestore.FieldValue.serverTimestamp(),
    }, { merge: true });
  } catch (e) { console.warn('Firestore write failed:', e); }
}

// â”€â”€ Auth tab switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchAuthTab(key, el) {
  document.querySelectorAll('.auth-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('form-' + key).classList.add('active');
  clearErrors();
}

// â”€â”€ Sign In â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-pass').value;
  if (!email || !pass) { showError('login-error', 'Please fill all fields.'); return; }
  clearErrors();
  setLoading('login-btn', true);
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    showToast('Welcome back!');
  } catch (e) {
    showError('login-error', firebaseErrorMessage(e));
  } finally {
    setLoading('login-btn', false);
  }
}

// â”€â”€ Register â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleRegister() {
  const name  = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass  = document.getElementById('reg-pass').value;
  const pass2 = document.getElementById('reg-pass2').value;
  if (!name || !email || !pass) { showError('reg-error', 'Please fill all fields.'); return; }
  if (pass !== pass2)           { showError('reg-error', 'Passwords do not match.'); return; }
  if (pass.length < 8)          { showError('reg-error', 'Password must be at least 8 characters.'); return; }
  clearErrors();
  setLoading('reg-btn', true);

  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await cred.user.updateProfile({ displayName: name });
    await saveFirestoreProfile(cred.user, name);

    // If this is a post-subscription registration, write subscription to Firestore
    if (_newSubData) {
      await writeSubToFirestore(cred.user, _newSubData);
      sessionStorage.removeItem('lk_new_sub');
      _newSubData = null;
      showToast('ğŸ‰ Account created & subscription activated!');
    } else {
      showToast('Account created! Welcome, ' + name + '!');
    }
    // onAuthStateChanged fires â†’ showProfile() called automatically
  } catch (e) {
    showError('reg-error', firebaseErrorMessage(e));
  } finally {
    setLoading('reg-btn', false);
  }
}

// â”€â”€ Password reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showForgot() {
  const email = document.getElementById('login-email').value.trim();
  if (!email) { showError('login-error', 'Enter your email above first, then click Reset.'); return; }
  try {
    await auth.sendPasswordResetEmail(email);
    showToast('Reset email sent â€” check your inbox.');
  } catch (e) { showError('login-error', firebaseErrorMessage(e)); }
}

async function showChangePassword() {
  const user = auth.currentUser;
  if (!user) return;
  try {
    await auth.sendPasswordResetEmail(user.email);
    showToast('Password reset email sent to ' + user.email);
  } catch (e) { showToast('Could not send reset email: ' + e.message); }
}

// â”€â”€ Sign out â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function signOut() {
  await auth.signOut();
  showToast('Signed out. See you soon!');
}

// â”€â”€ Load owned books â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOwnedBooks(profile) {
  let allBooks = [];
  try {
    const r = await fetch('https://raw.githubusercontent.com/achatterjee4561-cyber/library/main/library.json');
    const j = await r.json();
    allBooks = j.books || [];
    sessionStorage.setItem('library_cache', JSON.stringify(j));
  } catch {
    const cached = sessionStorage.getItem('library_cache');
    if (cached) allBooks = JSON.parse(cached).books || [];
  }

  // Show all books since subscriber gets full access
  const sub = await resolveSubscription(auth.currentUser, profile);
  const list = document.getElementById('ownedList');

  if (sub.active) {
    if (!allBooks.length) {
      list.innerHTML = `<div class="empty-owned"><span>ğŸŒ¿</span>Library is loadingâ€¦</div>`;
      return;
    }
    list.innerHTML = '';
    allBooks.filter(b => b.file || b.chapters).forEach(book => {
      const item = document.createElement('div');
      item.className = 'owned-item';
      item.innerHTML = `
        <div class="owned-thumb">ğŸ“•</div>
        <div class="owned-info">
          <div class="owned-title">${escHtml(book.title)}</div>
          <div class="owned-meta">${escHtml(book.author || '')} Â· ${escHtml(book.type || '')}</div>
        </div>
        <button class="owned-read-btn" onclick='openBook(${JSON.stringify(book)})'>Read â†’</button>`;
      list.appendChild(item);
    });
  } else {
    list.innerHTML = `<div class="empty-owned"><span>â­</span>Subscribe for â‚¹200/month to unlock every book.</div>`;
  }
}

function openBook(book) {
  sessionStorage.setItem('pending_book', JSON.stringify(book));
  nav('Reader.html');
}

// â”€â”€ Clear local data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearData() {
  if (!confirm('Clear local data? Your account and subscription are safe.')) return;
  localStorage.removeItem('lk_sub');
  localStorage.removeItem('lk_sub_utrs');
  showToast('Local data cleared.');
  location.reload();
}

// â”€â”€ Firebase error messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function firebaseErrorMessage(e) {
  const map = {
    'auth/user-not-found':         'No account found with that email.',
    'auth/wrong-password':         'Incorrect password.',
    'auth/email-already-in-use':   'An account with that email already exists.',
    'auth/weak-password':          'Password must be at least 6 characters.',
    'auth/invalid-email':          'Please enter a valid email address.',
    'auth/too-many-requests':      'Too many attempts. Please wait a moment.',
    'auth/network-request-failed': 'Network error â€” check your connection.',
    'auth/invalid-credential':     'Incorrect email or password.',
  };
  return map[e.code] || e.message;
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(btnId, loading) {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  btn.disabled = loading;
  btn.style.opacity = loading ? '0.6' : '1';
}
function showError(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg; el.classList.add('show');
}
function clearErrors() {
  document.querySelectorAll('.form-error').forEach(e => e.classList.remove('show'));
}
function nameFromEmail(email) {
  const part = email.split('@')[0].replace(/[._]/g, ' ');
  return part.charAt(0).toUpperCase() + part.slice(1);
}
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}
</script>
</body>
</html>
