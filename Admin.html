<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LK Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #0e0e0f;
    --surface:  #161618;
    --border:   #2a2a2e;
    --green:    #4ade80;
    --green-dim:#1a3d28;
    --red:      #f87171;
    --red-dim:  #3d1a1a;
    --gold:     #fbbf24;
    --gold-dim: #3d2e0a;
    --text:     #f0f0f0;
    --text-mid: #9a9a9a;
    --text-dim: #555;
    --radius:   10px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* â”€â”€ LOGIN SCREEN â”€â”€ */
  #loginScreen {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    z-index: 999; flex-direction: column; gap: 0;
  }
  .login-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 40px 36px; width: 100%; max-width: 360px;
    box-shadow: 0 24px 60px rgba(0,0,0,.6);
  }
  .login-brand {
    font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 900;
    color: var(--gold); text-align: center; margin-bottom: 6px; letter-spacing: .02em;
  }
  .login-sub { font-size: .75rem; color: var(--text-dim); text-align: center; margin-bottom: 28px; letter-spacing: .12em; text-transform: uppercase; }
  .login-field {
    width: 100%; padding: 11px 14px; border-radius: var(--radius);
    background: var(--bg); border: 1.5px solid var(--border);
    color: var(--text); font-family: 'DM Mono', monospace; font-size: .88rem;
    outline: none; transition: border-color .2s; margin-bottom: 14px;
  }
  .login-field:focus { border-color: var(--gold); }
  .login-btn {
    width: 100%; padding: 11px; border-radius: var(--radius);
    background: var(--gold); color: #0e0e0f; font-family: 'DM Sans', sans-serif;
    font-size: .88rem; font-weight: 600; border: none; cursor: pointer;
    transition: opacity .18s;
  }
  .login-btn:hover { opacity: .88; }
  .login-err { font-size: .75rem; color: var(--red); text-align: center; margin-top: 10px; min-height: 18px; }

  /* â”€â”€ MAIN APP â”€â”€ */
  #adminApp { display: none; min-height: 100vh; }

  .topbar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0 24px; height: 54px; display: flex; align-items: center;
    justify-content: space-between; position: sticky; top: 0; z-index: 50;
  }
  .topbar-brand { font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700; color: var(--gold); }
  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
  .status-label { font-size: .75rem; color: var(--text-mid); }
  .refresh-btn {
    background: var(--border); border: none; color: var(--text-mid);
    padding: 6px 14px; border-radius: 20px; font-size: .75rem; cursor: pointer;
    font-family: 'DM Sans', sans-serif; transition: all .18s;
  }
  .refresh-btn:hover { background: var(--text-dim); color: var(--text); }
  .logout-btn {
    background: transparent; border: 1px solid var(--border); color: var(--text-dim);
    padding: 6px 14px; border-radius: 20px; font-size: .75rem; cursor: pointer;
    font-family: 'DM Sans', sans-serif; transition: all .18s;
  }
  .logout-btn:hover { border-color: var(--red); color: var(--red); }

  /* â”€â”€ STATS BAR â”€â”€ */
  .stats-bar {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1px; background: var(--border); border-bottom: 1px solid var(--border);
  }
  .stat-cell { background: var(--surface); padding: 18px 24px; }
  .stat-label { font-size: .68rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: .1em; margin-bottom: 5px; }
  .stat-value { font-family: 'Playfair Display', serif; font-size: 1.6rem; font-weight: 700; color: var(--text); }
  .stat-value.green { color: var(--green); }
  .stat-value.gold  { color: var(--gold); }
  .stat-value.red   { color: var(--red); }

  /* â”€â”€ CONTENT â”€â”€ */
  .content { padding: 28px 24px; max-width: 960px; margin: 0 auto; }
  .section-title {
    font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700;
    color: var(--text); margin-bottom: 16px; display: flex; align-items: center; gap: 10px;
  }
  .badge {
    font-family: 'DM Sans', sans-serif; font-size: .68rem; font-weight: 600;
    padding: 2px 8px; border-radius: 10px; background: var(--gold-dim); color: var(--gold);
  }
  .badge.green { background: var(--green-dim); color: var(--green); }

  /* â”€â”€ CARDS â”€â”€ */
  .utr-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px; margin-bottom: 10px;
    display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center;
    transition: border-color .2s; animation: slideIn .2s ease;
  }
  @keyframes slideIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .utr-card:hover { border-color: #3a3a3e; }
  .utr-card.approved { border-color: var(--green-dim); background: rgba(74,222,128,.04); }
  .utr-card.rejected { border-color: var(--red-dim);   background: rgba(248,113,113,.04); opacity: .6; }

  .utr-info { display: flex; flex-direction: column; gap: 5px; }
  .utr-book { font-size: .88rem; font-weight: 600; color: var(--text); }
  .utr-code {
    font-family: 'DM Mono', monospace; font-size: .82rem;
    color: var(--gold); background: var(--gold-dim); padding: 2px 8px;
    border-radius: 5px; display: inline-block; width: fit-content;
  }
  .utr-meta { font-size: .72rem; color: var(--text-dim); margin-top: 2px; }
  .utr-amount { font-size: .8rem; color: var(--green); font-weight: 500; }

  .utr-actions { display: flex; gap: 8px; flex-shrink: 0; }
  .act-btn {
    padding: 8px 18px; border-radius: 8px; font-family: 'DM Sans', sans-serif;
    font-size: .78rem; font-weight: 600; border: none; cursor: pointer; transition: all .18s;
    white-space: nowrap;
  }
  .act-approve { background: var(--green-dim); color: var(--green); }
  .act-approve:hover { background: var(--green); color: #0e0e0f; }
  .act-reject  { background: var(--red-dim);   color: var(--red); }
  .act-reject:hover  { background: var(--red);   color: #0e0e0f; }
  .act-done { padding: 8px 18px; border-radius: 8px; font-size: .75rem; font-weight: 600; color: var(--text-dim); background: transparent; border: 1px solid var(--border); cursor: default; }

  .empty-state { text-align: center; padding: 50px 20px; color: var(--text-dim); font-size: .88rem; font-style: italic; }
  .empty-state span { display: block; font-size: 2rem; margin-bottom: 10px; }

  .divider { height: 1px; background: var(--border); margin: 28px 0; }

  /* â”€â”€ RECENT â”€â”€ */
  .recent-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 14px 18px; margin-bottom: 8px;
    display: flex; align-items: center; gap: 14px;
  }
  .recent-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
  .recent-info { flex: 1; }
  .recent-book { font-size: .82rem; color: var(--text); font-weight: 500; }
  .recent-meta { font-size: .7rem; color: var(--text-dim); margin-top: 2px; font-family: 'DM Mono', monospace; }
  .recent-amount { font-size: .82rem; color: var(--gold); font-weight: 600; flex-shrink: 0; }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--surface); color: var(--text); border: 1px solid var(--border);
    padding: 10px 22px; border-radius: 30px; font-size: .8rem;
    box-shadow: 0 8px 30px rgba(0,0,0,.5); transition: transform .3s ease; z-index: 999;
    white-space: nowrap;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }
  #toast.ok  { border-color: var(--green); color: var(--green); }
  #toast.err { border-color: var(--red);   color: var(--red); }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-brand">LiveKitaab</div>
    <div class="login-sub">Admin Access Only</div>
    <input class="login-field" type="password" id="loginInput"
           placeholder="Admin password"
           onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Enter</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- ADMIN APP -->
<div id="adminApp">
  <div class="topbar">
    <div class="topbar-brand">âš™ LiveKitaab Admin</div>
    <div class="topbar-right">
      <div class="status-dot"></div>
      <span class="status-label">Live</span>
      <button class="refresh-btn" onclick="loadAll()">â†» Refresh</button>
      <button class="logout-btn" onclick="doLogout()">Logout</button>
    </div>
  </div>

  <div class="stats-bar">
    <div class="stat-cell">
      <div class="stat-label">Pending Approvals</div>
      <div class="stat-value gold" id="statPending">â€“</div>
    </div>
    <div class="stat-cell">
      <div class="stat-label">Active Subscribers</div>
      <div class="stat-value green" id="statSubs">â€“</div>
    </div>
    <div class="stat-cell">
      <div class="stat-label">Sub Revenue</div>
      <div class="stat-value" id="statSubRev">â€“</div>
    </div>
    <div class="stat-cell">
      <div class="stat-label">Total Revenue</div>
      <div class="stat-value" id="statRevenue">â€“</div>
    </div>
  </div>

  <div class="content">

    <div class="section-title">
      Pending UTR Approvals
      <span class="badge" id="pendingBadge">0</span>
    </div>
    <div id="pendingList"></div>

    <div class="divider"></div>

    <div class="section-title">
      Active Subscriptions
      <span class="badge green" id="subsBadge">â€“</span>
    </div>
    <div id="subsList"></div>

    <div class="divider"></div>

    <div class="section-title">
      Books Read
      <span class="badge green" id="recentBadge">â€“</span>
    </div>
    <div id="recentList"></div>

  </div>
</div>

<div id="toast"></div>

<script>
const API    = 'https://web-production-a6ac9.up.railway.app';
const ADMIN_KEY = 'LiveKitaabAdminHaiAC@2014';

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
  const val = document.getElementById('loginInput').value.trim();
  if (val === ADMIN_KEY) {
    sessionStorage.setItem('lk_admin', '1');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminApp').style.display    = 'block';
    loadAll();
    // Auto-refresh every 30 seconds
    setInterval(loadAll, 30000);
  } else {
    document.getElementById('loginErr').textContent = 'Incorrect password.';
    document.getElementById('loginInput').select();
  }
}

function doLogout() {
  sessionStorage.removeItem('lk_admin');
  location.reload();
}

// Auto-login if session exists
window.addEventListener('DOMContentLoaded', () => {
  if (sessionStorage.getItem('lk_admin')) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminApp').style.display    = 'block';
    loadAll();
    setInterval(loadAll, 30000);
  }
});

// â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAll() {
  await Promise.all([loadPending(), loadRecent(), loadStats(), loadSubs()]);
}

async function loadStats() {
  try {
    const r = await fetch(`${API}/api/admin/stats`, {
      headers: { 'X-Admin-Key': ADMIN_KEY }
    });
    const d = await r.json();
    document.getElementById('statTotal').textContent   = d.total_purchases ?? 0;
    document.getElementById('statRevenue').textContent = 'â‚¹' + (d.total_revenue ?? 0);
  } catch { }
}

async function loadPending() {
  try {
    const r = await fetch(`${API}/api/admin/pending`, {
      headers: { 'X-Admin-Key': ADMIN_KEY }
    });
    const d = await r.json();
    const list = (d.purchases || []).filter(p => p.status === 'pending');
    document.getElementById('statPending').textContent  = list.length;
    document.getElementById('pendingBadge').textContent = list.length;

    const el = document.getElementById('pendingList');
    if (!list.length) {
      el.innerHTML = '<div class="empty-state"><span>âœ…</span>No pending approvals</div>';
      return;
    }
    el.innerHTML = '';
    list.slice().reverse().forEach(p => el.appendChild(makePendingCard(p)));
  } catch (e) {
    document.getElementById('pendingList').innerHTML =
      '<div class="empty-state">Could not load â€” check Railway is running</div>';
  }
}

async function loadRecent() {
  try {
    const r = await fetch(`${API}/api/admin/read-counts`, {
      headers: { 'X-Admin-Key': ADMIN_KEY }
    });
    const d = await r.json();
    const list = d.books || [];
    const totalReads = list.reduce((s, b) => s + b.total_reads, 0);
    document.getElementById('recentBadge').textContent = totalReads + ' reads';

    const el = document.getElementById('recentList');
    if (!list.length) {
      el.innerHTML = '<div class="empty-state"><span>ğŸ“–</span>No reads tracked yet</div>';
      return;
    }
    el.innerHTML = '';
    list.forEach((b, i) => el.appendChild(makeReadCard(b, i)));
  } catch(e) {
    document.getElementById('recentList').innerHTML =
      '<div class="empty-state">Could not load read counts</div>';
  }
}

// â”€â”€ SUBSCRIPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSubs() {
  try {
    const r = await fetch(`${API}/api/admin/subscriptions`, {
      headers: { 'X-Admin-Key': ADMIN_KEY }
    });
    const d = await r.json();
    const list = (d.subscriptions || []).filter(s => s.status === 'confirmed');

    // Count active (not expired)
    const now = new Date();
    const active = list.filter(s => {
      if (!s.confirmed_at) return false;
      const expiry = new Date(s.confirmed_at);
      expiry.setDate(expiry.getDate() + (s.days || 30));
      return expiry > now;
    });

    document.getElementById('statSubs').textContent    = active.length;
    document.getElementById('statSubRev').textContent  = 'â‚¹' + (list.length * 200);
    document.getElementById('subsBadge').textContent   = active.length;

    const el = document.getElementById('subsList');
    if (!list.length) {
      el.innerHTML = '<div class="empty-state"><span>ğŸ“‹</span>No subscribers yet</div>';
      return;
    }
    el.innerHTML = '';
    list.slice().reverse().forEach(s => el.appendChild(makeSubCard(s)));
  } catch (e) {
    document.getElementById('subsList').innerHTML =
      '<div class="empty-state">Could not load subscriptions</div>';
  }
}

function makeSubCard(s) {
  const card = document.createElement('div');
  card.className = 'recent-card';
  const confirmed = s.confirmed_at ? new Date(s.confirmed_at) : null;
  const expiry    = confirmed ? new Date(confirmed) : null;
  if (expiry) expiry.setDate(expiry.getDate() + (s.days || 30));
  const now    = new Date();
  const active = expiry && expiry > now;
  const daysLeft = expiry ? Math.max(0, Math.ceil((expiry - now) / 86400000)) : 0;
  const ts = confirmed ? confirmed.toLocaleString('en-IN') : 'â€“';
  card.innerHTML = `
    <div class="recent-dot" style="background:${active?'var(--green)':'var(--red)'}"></div>
    <div class="recent-info">
      <div class="recent-book">${active ? 'â­ Active Subscriber' : 'â° Expired'}</div>
      <div class="recent-meta">${esc(s.transaction_id||'â€“')} Â· ${ts}${active?' Â· '+daysLeft+' days left':''}</div>
    </div>
    <div class="recent-amount">â‚¹200</div>
  `;
  return card;
}

// â”€â”€ CARD BUILDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makePendingCard(p) {
  const card = document.createElement('div');
  card.className = 'utr-card';
  card.id = 'card-' + p.verification_code;

  const ts = p.timestamp ? new Date(p.timestamp).toLocaleString('en-IN') : 'â€“';

  card.innerHTML = `
    <div class="utr-info">
      <div class="utr-book">ğŸ“– ${esc(p.book_id || 'â€“')}</div>
      <div class="utr-code">${esc(p.transaction_id || 'â€“')}</div>
      <div class="utr-meta">${ts} &nbsp;Â·&nbsp; Code: <strong>${esc(p.verification_code)}</strong></div>
      <div class="utr-amount">â‚¹${p.price ?? 'â€“'}</div>
    </div>
    <div class="utr-actions">
      <button class="act-btn act-approve" onclick="approve('${esc(p.verification_code)}')">âœ“ Approve</button>
      <button class="act-btn act-reject"  onclick="reject('${esc(p.verification_code)}')">âœ• Reject</button>
    </div>
  `;
  return card;
}

function makeReadCard(b, rank) {
  const card = document.createElement('div');
  card.className = 'recent-card';
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const medal  = medals[rank] || 'ğŸ“–';
  const bar    = b.total_reads > 0
    ? `<div style="height:4px;border-radius:2px;background:var(--border);margin-top:6px;overflow:hidden;">
         <div style="height:100%;border-radius:2px;background:var(--green);width:${Math.min(100, b.total_reads * 10)}%;transition:width .4s;"></div>
       </div>` : '';
  card.innerHTML = `
    <div class="recent-dot" style="background:var(--gold);font-size:1.1rem;width:auto;height:auto;border-radius:0;background:transparent;">${medal}</div>
    <div class="recent-info">
      <div class="recent-book">${esc(b.title || b.book_id)}</div>
      <div class="recent-meta">Free: ${b.free_reads} &nbsp;Â·&nbsp; Subscribers: ${b.sub_reads}</div>
      ${bar}
    </div>
    <div class="recent-amount" style="color:var(--gold);font-size:1rem;font-weight:700;">${b.total_reads}</div>
  `;
  return card;
}

// â”€â”€ APPROVE / REJECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function approve(code) {
  const card = document.getElementById('card-' + code);
  if (card) {
    card.querySelector('.utr-actions').innerHTML = '<span class="act-done">Processingâ€¦</span>';
  }
  try {
    const r = await fetch(`${API}/api/verify-purchase`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ verification_code: code, admin_key: ADMIN_KEY })
    });
    const d = await r.json();
    if (d.success) {
      toast('âœ“ Approved â€” book unlocked for user', 'ok');
      if (card) { card.className = 'utr-card approved'; card.querySelector('.utr-actions').innerHTML = '<span class="act-done">âœ“ Approved</span>'; }
      setTimeout(loadAll, 1000);
    } else {
      toast('Error: ' + (d.error || 'Unknown'), 'err');
      if (card) card.querySelector('.utr-actions').innerHTML =
        `<button class="act-btn act-approve" onclick="approve('${code}')">âœ“ Approve</button>
         <button class="act-btn act-reject"  onclick="reject('${code}')">âœ• Reject</button>`;
    }
  } catch (e) {
    toast('Network error', 'err');
  }
}

async function reject(code) {
  if (!confirm('Reject this UTR submission?')) return;
  try {
    const r = await fetch(`${API}/api/reject-purchase`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ verification_code: code, admin_key: ADMIN_KEY })
    });
    const d = await r.json();
    if (d.success) {
      toast('Rejected', 'err');
      const card = document.getElementById('card-' + code);
      if (card) { card.className = 'utr-card rejected'; card.querySelector('.utr-actions').innerHTML = '<span class="act-done">âœ• Rejected</span>'; }
      setTimeout(loadAll, 1000);
    }
  } catch { toast('Network error', 'err'); }
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

let _tt;
function toast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'show ' + type;
  clearTimeout(_tt); _tt = setTimeout(() => t.className = '', 3000);
}
</script>
</body>
</html>
